{% extends "_components/base_site.html" %}
{% load static i18n %}

{% block title %}{% trans "Consultorio Dental Rodolfo Castell√≥n | Sistema integral" %}{% endblock %}
{% block meta_description %}{% trans "Atenci√≥n dental profesional en Puerto Vallarta. Citas en l√≠nea, pagos seguros." %}{% endblock %}

{% block extra_head %}
<link rel="preload" href="{% static 'img/fondodentista1.jpg' %}" as="image">
<link rel="stylesheet" href="{% static 'site.css' %}?v=FINAL_ROBOTIC">
{% endblock %}

{% block content %}
<div class="bg-shapes">
  <div class="orb orb-a"></div>
  <div class="orb orb-b"></div>
  <div class="orb orb-c"></div>
</div>
<header class="hero">
  <div class="hero-overlay"></div>
  <div class="hero-inner wrap">
    <div class="kicker">{% trans "SISTEMA INTEGRAL ‚Ä¢ PUERTO VALLARTA" %}</div>
    <h1 class="hero-title reveal">{% trans "Consultorio Dental Rodolfo Castell√≥n" %}</h1>
    <p class="lead reveal">
        {% blocktrans %}<strong>Sistema integral</strong> para la <strong>gesti√≥n de pacientes, citas y pagos</strong>. Tecnolog√≠a moderna, trato humano y precios accesibles.{% endblocktrans %}
    </p>
    <div class="cta reveal">
      <a class="rc-btn whatsapp-btn" href="https://wa.me/523228892558" target="_blank">
          <i class="ph-fill ph-whatsapp-logo"></i> WhatsApp
      </a>
      <a href="{% url 'accounts:login' %}" class="rc-btn">{% trans "Iniciar sesi√≥n" %}</a>
      <a href="{% url 'accounts:register' %}" class="rc-btn rc-btn--primary">{% trans "Agenda tu cita" %}</a>
    </div>
    <div class="stats-grid reveal">
        <div class="stat-card"><h3>500+</h3><p>{% trans "Procedimientos" %}</p></div>
        <div class="stat-card"><h3>4.7/5 ‚ú®</h3><p>{% trans "Satisfacci√≥n" %}</p></div>
        <div class="stat-card"><h3>6+ {% trans "a√±os" %}</h3><p>{% trans "Experiencia" %}</p></div>
    </div>
  </div>
</header>

<main>
  <section id="servicios" class="bg-dark">
    <div class="wrap">
        <h2 class="section-title reveal">{% trans "Servicios principales" %}</h2>
        <p class="section-lead reveal">{% trans "Tratamientos personalizados para cada sonrisa." %}</p>
        
        <div class="grid-3 mt-3">
          <article class="svc-card reveal">
            <div class="svc-card-ico"><img src="{% static 'img/odontologia general.png' %}" alt="General"></div>
            <h3>{% trans "Odontolog√≠a General" %}</h3>
            <ul><li>{% trans "Limpieza profunda" %}</li><li>{% trans "Resinas" %}</li><li>{% trans "Extracciones" %}</li></ul>
          </article>
          <article class="svc-card reveal">
            <div class="svc-card-ico"><img src="{% static 'img/Ortodoncia.png' %}" alt="Ortodoncia"></div>
            <h3>{% trans "Ortodoncia" %}</h3>
            <ul><li>{% trans "Brackets est√©ticos" %}</li><li>{% trans "Alineadores" %}</li></ul>
          </article>
          <article class="svc-card reveal">
            <div class="svc-card-ico"><img src="{% static 'img/Odontolog√≠a est√©tica.png' %}" alt="Est√©tica"></div>
            <h3>{% trans "Est√©tica" %}</h3>
            <ul><li>{% trans "Blanqueamiento" %}</li><li>{% trans "Carillas" %}</li></ul>
          </article>
          <article class="svc-card reveal">
            <div class="svc-card-ico"><img src="{% static 'img/odontologia Restaurativa.png' %}" alt="Restaurativa"></div>
            <h3>{% trans "Restaurativa" %}</h3>
            <ul><li>{% trans "Coronas" %}</li><li>{% trans "Incrustaciones" %}</li></ul>
          </article>
          <article class="svc-card reveal">
            <div class="svc-card-ico"><img src="{% static 'img/protesis e implantes.png' %}" alt="Implantes"></div>
            <h3>{% trans "Pr√≥tesis" %}</h3>
            <ul><li>{% trans "Implantes dentales" %}</li><li>{% trans "Puentes" %}</li></ul>
          </article>
          <article class="svc-card reveal">
            <div class="svc-card-ico"><img src="{% static 'img/recordatorio.png' %}" alt="Agenda"></div>
            <h3>{% trans "Agenda Digital" %}</h3>
            <p>{% trans "Recordatorios autom√°ticos." %}</p>
          </article>
        </div>
    </div>
  </section>

  <section id="acerca" class="bg-panel">
    <div class="wrap">
        <div class="grid-2 align-center">
          <div class="reveal">
            <h2 class="section-title">{% trans "Acerca del consultorio" %}</h2>
            <p class="lead">{% trans "Ubicados en El Pitillal, Puerto Vallarta, ofrecemos tratamientos de √∫ltima generaci√≥n con un trato humano." %}</p>
            <ul class="feature-list">
                <li>{% trans "Horario flexible: Lunes, 7 am - 7pm y Sabados, 9 a 2" %}</li>
                <li>{% trans "Tecnolog√≠a moderna y ambiente seguro" %}</li>
                <li>{% trans "Atenci√≥n personalizada por el Dr. Castell√≥n" %}</li>
            </ul>
            <a href="{% url 'accounts:register' %}" class="rc-btn rc-btn--primary mt-2">{% trans "Quiero una valoraci√≥n" %}</a>
          </div>
          <div class="reveal">
            <img src="{% static 'img/dentista.jpg' %}" alt="Consultorio" class="feature-img">
          </div>
        </div>
    </div>
  </section>

  <section id="sistema" class="bg-dark">
    <div class="wrap">
      <div class="panel-card panel-grid reveal">
        <div>
          <h2 class="section-title" style="margin-bottom:0.5rem;">{% trans "Sistema digital RC" %}</h2>
          <p class="section-lead" style="margin-bottom:1.5rem;">{% trans "Agenda, pagos y recordatorios conectados para pacientes y dentistas." %}</p>
          <p class="lead" style="font-size:1.05rem; color:var(--muted);">{% trans "Un panel para el dentista y otro para el paciente, sincronizados con correos, penalizaciones y cobros en l√≠nea." %}</p>
          <div class="cta" style="justify-content:flex-start; margin-top:1.5rem;">
            <a href="{% url 'accounts:register' %}" class="rc-btn rc-btn--primary">{% trans "Crear mi cuenta" %}</a>
            <a href="{% url 'accounts:login' %}" class="rc-btn">{% trans "Acceder" %}</a>
          </div>
        </div>
        <div>
          <div class="pill-list">
            <div class="pill">
              <div class="pill-icon"><i class="ph-fill ph-calendar-check"></i></div>
              <div>
                <strong>{% trans "Agenda inteligente" %}</strong>
                <small>{% trans "Slots en tiempo real, reprogramaciones y confirmaciones por correo." %}</small>
              </div>
            </div>
            <div class="pill">
              <div class="pill-icon"><i class="ph-fill ph-credit-card"></i></div>
              <div>
                <strong>{% trans "Pagos con MercadoPago" %}</strong>
                <small>{% trans "Cobros seguros, recibos en PDF y conciliaci√≥n autom√°tica." %}</small>
              </div>
            </div>
            <div class="pill">
              <div class="pill-icon"><i class="ph-fill ph-bell"></i></div>
              <div>
                <strong>{% trans "Recordatorios 24h" %}</strong>
                <small>{% trans "Correos autom√°ticos antes de la cita y enlaces de confirmaci√≥n." %}</small>
              </div>
            </div>
            <div class="pill">
              <div class="pill-icon"><i class="ph-fill ph-shield-check"></i></div>
              <div>
                <strong>{% trans "Seguridad y acceso" %}</strong>
                <small>{% trans "Verificaci√≥n de email y control de penalizaciones por inasistencias." %}</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="pagos" class="bg-dark text-center">
    <div class="wrap pagos-wrap">
        <h2 class="section-title reveal">{% trans "Formas de pago" %}</h2>
        <p class="section-lead reveal pagos-sub">{% trans "Flexibilidad para tu comodidad." %}</p>
        <div class="badges reveal justify-center">
          <span class="badge"><i class="ph-fill ph-money"></i> {% trans "Efectivo" %}</span>
          <span class="badge active"><i class="ph-fill ph-credit-card"></i> {% trans "MercadoPago" %}</span>
          <span class="badge"><i class="ph-fill ph-bank"></i> {% trans "Transferencia" %}</span>
        </div>
    </div>
  </section>
  
  <section id="contacto" class="bg-panel">
    <div class="wrap">
        <div class="grid-2">
          <div class="cyber-card reveal">
            <h3>{% trans "Cont√°ctanos" %}</h3>
            <ul class="contact-list">
              <li><i class="ph-fill ph-phone text-brand"></i> <a href="tel:+523228892558">+52 322 889 2558</a></li>
              <li><i class="ph-fill ph-envelope text-brand"></i> dentista.choyo@gmail.com</li>
              <li><i class="ph-fill ph-map-pin text-brand"></i> {% trans "Calle Guatemala #125, El Pitillal" %}</li>
            </ul>
          </div>
          <div class="reveal map-container">
            <iframe title="{% trans 'Ubicaci√≥n' %}" loading="lazy" src="https://www.google.com/maps?q=Calle%20Guatemala%20125%20El%20Pitillal%20Puerto%20Vallarta&output=embed"></iframe>
          </div>
        </div>
    </div>
  </section>
</main>

<!-- Chat flotante -->
<div id="rc-chat-scrim" class="rc-chat-scrim"></div>
<div id="rc-chat-toggle" class="rc-chat-toggle">
  <i class="ph-bold ph-robot"></i>
  <span class="rc-pulse-dot"></span>
</div>
<div id="rc-chatbox" class="rc-chatbox"
  data-greeting="{% trans 'Hola üëã Bienvenido/a. Puedo ayudarte a agendar una cita, consultar servicios y precios, o atender una urgencia. Elige una opci√≥n para comenzar.' %}"
  data-placeholder="{% trans 'Elige una opci√≥n o escribe tu duda...' %}"
  data-subtitle="{% trans 'Agenda ¬∑ Precios ¬∑ Urgencias ¬∑ Ubicaci√≥n ¬∑ Pagos' %}"
  data-error="{% trans 'Error al conectar. Intenta de nuevo.' %}">
  <div class="rc-chat-header">
    <div class="rc-head-left">
      <div class="chat-head-meta">
        <div class="chat-status-row"><span class="chat-dot"></span><span class="chat-status-text">{% trans "En l√≠nea" %}</span></div>
        <div class="chat-title">RC/AI Core</div>
        <div class="chat-desc">{% trans "Entrenado en agenda, pagos y penalizaciones" %}</div>
      </div>
    </div>
    <button id="rc-chat-close" class="rc-chat-close" aria-label="Cerrar chat"><i class="ph-bold ph-x"></i></button>
  </div>
  <div id="rc-chat-messages" class="rc-chat-messages"></div>
  <div class="rc-quick-replies" id="rc-quick-replies">
    <button class="rc-chip" data-msg="{% trans 'Quiero agendar una cita' %}">ü§ñ {% trans "Agendar (IA)" %}</button>
    <button class="rc-chip" data-msg="{% trans '¬øC√≥mo pagar mi penalizaci√≥n?' %}">üí≥ {% trans "Penalizaci√≥n" %}</button>
    <button class="rc-chip" data-msg="{% trans '¬øCu√°les son los horarios disponibles?' %}">‚è∞ {% trans "Horarios" %}</button>
    <button class="rc-chip" data-msg="{% trans 'Ubicaci√≥n del consultorio' %}">üìç {% trans "Ubicaci√≥n" %}</button>
  </div>
  <div class="rc-legal">Este asistente no sustituye una consulta. Para urgencias graves, acude a un servicio m√©dico.</div>
  <form id="rc-chat-form" class="rc-chat-form">
    <input id="rc-chat-input" type="text" placeholder="{% trans 'Escribe tu pregunta...' %}" autocomplete="off" required />
    <button type="submit" aria-label="{% trans 'Enviar' %}"><i class="ph-bold ph-paper-plane-tilt"></i></button>
  </form>
</div>

{% endblock %}

{% block extra_js %}
<style>
  .rc-chat-scrim { position: fixed; inset: 0; background: linear-gradient(180deg, rgba(3,6,12,0.55), rgba(3,6,12,0.75)); backdrop-filter: blur(4px); opacity: 0; pointer-events: none; transition: opacity 0.3s ease; z-index: 1150; }
  .rc-chat-toggle {
    position: fixed; bottom: 22px; right: 22px; z-index: 1200;
    background: conic-gradient(from 210deg, #12d2ae, #6dcffb, #16c4a7);
    color: #06111f; width: 70px; height: 70px; border-radius: 20px;
    display: grid; place-items: center; font-size: 26px; cursor: pointer;
    box-shadow: 0 24px 60px -22px rgba(0,0,0,0.75), 0 0 0 6px rgba(18,210,174,0.12), 0 18px 46px -18px rgba(109,207,251,0.45);
    transition: transform 0.25s ease, box-shadow 0.25s ease;
    overflow: hidden;
  }
  .rc-chat-toggle::after {
    content: ""; position: absolute; inset: 10px; border-radius: 14px;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.32), transparent 42%);
    opacity: 0.85; pointer-events: none; filter: blur(1.5px);
  }
  .rc-chat-toggle:hover { transform: translateY(-3px) scale(1.03); box-shadow: 0 30px 70px -22px rgba(0,0,0,0.8), 0 0 0 8px rgba(109,207,251,0.14), 0 20px 48px -18px rgba(18,210,174,0.28); }
  .rc-pulse-dot { position: absolute; width: 10px; height: 10px; background: #3ef3c5; border-radius: 999px; top: 10px; right: 10px; box-shadow: 0 0 0 0 rgba(62,243,197,0.45); animation: pulse 2s infinite; }
  @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(62,243,197,0.45); } 70% { box-shadow: 0 0 0 12px rgba(62,243,197,0); } 100% { box-shadow: 0 0 0 0 rgba(62,243,197,0); } }
  .rc-chatbox {
    position: fixed; bottom: 94px; right: 16px; width: 340px; max-height: 78vh;
    background:
      linear-gradient(155deg, rgba(4, 8, 16, 0.94), rgba(5, 10, 18, 0.96)),
      radial-gradient(circle at 18% 12%, rgba(62,243,197,0.12), transparent 36%),
      radial-gradient(circle at 82% 4%, rgba(125,211,252,0.12), transparent 32%),
      repeating-linear-gradient(90deg, rgba(255,255,255,0.04), rgba(255,255,255,0.04) 1px, transparent 1px, transparent 22px),
      repeating-linear-gradient(0deg, rgba(255,255,255,0.04), rgba(255,255,255,0.04) 1px, transparent 1px, transparent 22px);
    color: #e6eefc; border-radius: 22px;
    box-shadow: 0 32px 90px rgba(0,0,0,0.82), 0 0 0 1px rgba(255,255,255,0.05);
    display: none; flex-direction: column; overflow: hidden; z-index: 1200;
    border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(12px);
  }
  .rc-chatbox::before {
    content: ""; position: absolute; inset: 0; pointer-events: none;
    background: linear-gradient(120deg, rgba(62,243,197,0.12), transparent 40%, rgba(125,211,252,0.08));
    mask-image: linear-gradient(180deg, rgba(255,255,255,0.85), transparent 90%);
  }
  .rc-chat-header {
    padding: 16px 18px; background: linear-gradient(120deg, rgba(62,243,197,0.18), rgba(125,211,252,0.14));
    color: #e6eefc; display: flex; align-items: center; justify-content: space-between;
    box-shadow: 0 12px 32px rgba(0,0,0,0.32); border-bottom: 1px solid rgba(255,255,255,0.08);
    gap: 12px;
  }
  .rc-head-left { display: flex; align-items: flex-start; gap: 10px; }
  .chat-head-meta { display: flex; flex-direction: column; gap: 6px; }
  .chat-status-row { display: flex; align-items: center; gap: 6px; font-size: 0.9rem; font-weight: 700; color: #b4ddff; }
  .chat-status-text { white-space: nowrap; }
  .chat-dot { width: 10px; height: 10px; border-radius: 999px; background: #3ef3c5; box-shadow: 0 0 0 8px rgba(62,243,197,0.12); }
  .chat-title { font-weight: 800; font-size: 1.1rem; letter-spacing: -0.01em; line-height: 1.2; max-width: 240px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
  .chat-desc { font-size: 0.88rem; color: #adc6e6; opacity: 0.92; max-width: 260px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
  .rc-robot-chip { display: grid; grid-template-columns: repeat(2, 10px); align-items: center; gap: 8px; padding: 8px 12px; border-radius: 14px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); box-shadow: inset 0 1px 0 rgba(255,255,255,0.1), 0 10px 22px -16px rgba(0,0,0,0.5); position: relative; overflow: hidden; }
  .rc-robot-chip::after { content: "AI"; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 10px; letter-spacing: 0.08em; color: #b4ddff; opacity: 0.7; }
  .rc-robot-chip .rc-eye { width: 10px; height: 10px; border-radius: 50%; background: #3ef3c5; box-shadow: 0 0 0 6px rgba(62,243,197,0.12); animation: blink 4s infinite; }
  .rc-robot-chip .rc-eye.right { animation-delay: 1s; }
  .rc-robot-chip .rc-wave { grid-column: 1 / span 2; height: 2px; width: 100%; background: linear-gradient(90deg, transparent, #3ef3c5, transparent); animation: sweep 2.6s linear infinite; opacity: 0.8; }
  @keyframes blink { 0%, 92%, 100% { transform: scaleY(1); } 94% { transform: scaleY(0.1); } }
  @keyframes sweep { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
  .rc-chat-close { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.18); color: #e6eefc; width: 40px; height: 40px; border-radius: 14px; cursor: pointer; display: grid; place-items: center; transition: transform 0.2s, background 0.2s; }
  .rc-chat-close:hover { transform: translateY(-2px); background: rgba(255,255,255,0.15); }
  .rc-chat-messages { padding: 18px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 14px; background: linear-gradient(180deg, rgba(255,255,255,0.012), transparent 55%), radial-gradient(circle at 16% 18%, rgba(62,243,197,0.06), transparent 40%), repeating-linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.02) 1px, transparent 1px, transparent 20px), repeating-linear-gradient(0deg, rgba(255,255,255,0.02), rgba(255,255,255,0.02) 1px, transparent 1px, transparent 20px); }
  .rc-bubble { padding: 13px 15px; border-radius: 16px; max-width: 92%; font-size: 14px; line-height: 1.55; position: relative; border: 1px solid transparent; backdrop-filter: blur(3px); }
  .rc-bubble.user { background: linear-gradient(135deg, #e8fff8, #e2f4ff); color: #0a1424; margin-left: auto; font-weight: 750; box-shadow: 0 16px 32px -18px rgba(88,199,255,0.5), 0 12px 28px -18px rgba(33,214,178,0.45); border-color: rgba(88,199,255,0.2); }
  .rc-bubble.bot { background: rgba(255,255,255,0.05); border: 1px solid rgba(62,243,197,0.18); box-shadow: 0 18px 42px -26px rgba(0,0,0,0.78); }
  .rc-bubble.bot::before {
    content: ""; position: absolute; inset: 0; border-radius: inherit; padding: 1px;
    background: linear-gradient(135deg, rgba(62,243,197,0.24), rgba(125,211,252,0.16));
    -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
    -webkit-mask-composite: xor; mask-composite: exclude;
  }
  .rc-badge { position: absolute; bottom: -10px; left: 12px; font-size: 10px; padding: 3px 6px; border-radius: 999px; background: rgba(62,243,197,0.16); color: #cde7ff; text-transform: uppercase; letter-spacing: 0.4px; }
  .rc-bubble.ia .rc-badge { background: #3ef3c5; color: #05101d; }
  .rc-quick-replies { position: relative; padding: 12px 16px; border-top: 1px solid rgba(255,255,255,0.08); display: flex; gap: 10px; overflow-x: auto; scrollbar-width: none; background: rgba(255,255,255,0.02); backdrop-filter: blur(10px); flex-wrap: wrap; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; }
  .rc-quick-replies::-webkit-scrollbar { display: none; }
  .rc-quick-replies::before,
  .rc-quick-replies::after { content: ""; position: absolute; top: 0; bottom: 0; width: 24px; pointer-events: none; background: linear-gradient(90deg, rgba(4,8,16,0.85), transparent); z-index: 1; }
  .rc-quick-replies::after { right: 0; left: auto; transform: scaleX(-1); }
  .rc-chip { border: 1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.07); color: #e6eefc; padding: 10px 14px; border-radius: 16px; font-size: 12px; cursor: pointer; transition: all 0.2s; white-space: normal; box-shadow: 0 12px 26px -20px rgba(0,0,0,0.6); min-width: 120px; line-height: 1.4; text-align: left; scroll-snap-align: start; }
  .rc-chip:hover { background: linear-gradient(135deg, #3ef3c5, #7dd3fc); color: #05101d; border-color: rgba(255,255,255,0.2); }
  .rc-legal { font-size: 11px; color: #9fb6d1; padding: 8px 16px 4px; border-top: 1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.02); }
  .rc-chat-form { display: flex; gap: 10px; padding: 12px 16px; border-top: 1px solid rgba(255,255,255,0.08); background: rgba(5,9,16,0.92); }
  .rc-chat-form input { flex: 1; padding: 13px 12px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.06); color: #e2e8f0; box-shadow: inset 0 1px 0 rgba(255,255,255,0.08); }
  .rc-chat-form input:focus { outline: none; border-color: #3ef3c5; box-shadow: 0 0 0 4px rgba(62,243,197,0.14); }
  .rc-chat-form button { background: linear-gradient(135deg, #3ef3c5, #7dd3fc); color: #05101d; border: 1px solid rgba(255,255,255,0.14); border-radius: 15px; padding: 0 14px; cursor: pointer; font-weight: 800; width: 50px; display: grid; place-items: center; box-shadow: 0 14px 26px -16px rgba(62,243,197,0.5); }
  @media (max-width: 640px) {
    .rc-chatbox { right: 12px; left: 12px; width: auto; }
    .rc-chat-toggle { right: 12px; }
  }
</style>
<script>
  (function() {
    const toggle = document.getElementById("rc-chat-toggle");
    const chat = document.getElementById("rc-chatbox");
    const scrim = document.getElementById("rc-chat-scrim");
    const closeBtn = document.getElementById("rc-chat-close");
    const form = document.getElementById("rc-chat-form");
    const input = document.getElementById("rc-chat-input");
    const messages = document.getElementById("rc-chat-messages");
    const quicks = document.querySelectorAll("#rc-quick-replies .rc-chip");
    const endpoint = "/api/chatbot/";
    const t = {
      greeting: chat?.dataset.greeting || "Hola, soy el asistente de la cl√≠nica. ¬øEn qu√© te ayudo?",
      placeholder: chat?.dataset.placeholder || "Elige una opci√≥n o escribe tu duda...",
      error: chat?.dataset.error || "Error al conectar. Intenta de nuevo.",
    };

    if (input && t.placeholder) input.placeholder = t.placeholder;

    const sanitize = (text) => {
      if (!text) return text;
      return text
        .replace(/0\.0\.0\.0:\d+/g, "consultoriorc.com")
        .replace(/LOCAL:?/gi, "")
        .trim();
    };

    const append = (text, role, source, isLoader=false) => {
      const lastGroup = messages.querySelector(".chat-group:last-child");
      const lastRole = lastGroup ? (lastGroup.classList.contains("bot") ? "bot" : "user") : null;

      let group = lastGroup;
      if (lastRole !== role) {
        group = document.createElement("div");
        group.className = `chat-group ${role}`;
        if (role === "bot") {
          const avatar = document.createElement("div");
          avatar.className = "chat-avatar";
          avatar.textContent = "RC";
          group.appendChild(avatar);
        } else {
          group.style.gridTemplateColumns = "1fr";
        }
        const block = document.createElement("div");
        block.className = "chat-block";
        group.appendChild(block);
        messages.appendChild(group);
      }

      const block = group.querySelector(".chat-block");
      const bubble = document.createElement("div");
      bubble.className = `rc-bubble chat-msg ${role}`;
      bubble.textContent = isLoader ? "..." : sanitize(text);
      block.appendChild(bubble);
      messages.scrollTop = messages.scrollHeight;
      return bubble;
    };

    const state = { flow: null, step: 0, data: {} };

    const mainMenu = [
      { label: "üìÖ Agendar cita", value: "agendar", flow: "agendar" },
      { label: "ü¶∑ Servicios y precios", value: "servicios", flow: "servicios" },
      { label: "üö® ¬øEs una urgencia?", value: "urgencias", flow: "urgencias" },
      { label: "üìç Ubicaci√≥n y horarios", value: "ubicacion", flow: "ubicacion" },
      { label: "üí≥ Pagos y facturaci√≥n", value: "pagos", flow: "pagos" },
      { label: "üë©‚Äç‚öïÔ∏è Hablar con recepci√≥n", value: "humano", flow: "humano" },
    ];

    const renderQuickReplies = (items) => {
      const wrap = document.getElementById("rc-quick-replies");
      if (!wrap) return;
      wrap.innerHTML = "";
      items.forEach(item => {
        const btn = document.createElement("button");
        btn.className = "rc-chip";
        btn.textContent = item.label;
        btn.dataset.msg = item.value;
        if (item.flow) btn.dataset.flow = item.flow;
        wrap.appendChild(btn);
      });
    };

    const setMenu = () => renderQuickReplies(mainMenu);
    setMenu();

    const resetFlow = () => { state.flow = null; state.step = 0; state.data = {}; setMenu(); };
    const genFolio = () => `RC-${Math.random().toString(36).slice(2,6).toUpperCase()}${Date.now().toString().slice(-2)}`;
    const isMenuCommand = (txt) => ["menu","men√∫","inicio","volver","reiniciar"].includes(txt.toLowerCase());

    const handleFlow = (text) => {
      const normalized = text.trim();
      const flow = state.flow;

      if (flow === "agendar") {
        if (state.step === 0) {
          state.data.paciente = normalized;
          state.step = 1;
          renderQuickReplies([
            { label: "Limpieza", value: "Limpieza" },
            { label: "Resina", value: "Resina" },
            { label: "Extracci√≥n", value: "Extracci√≥n" },
            { label: "Endodoncia", value: "Endodoncia" },
            { label: "Brackets", value: "Brackets" },
            { label: "Blanqueamiento", value: "Blanqueamiento" },
            { label: "Dolor/Urgencia", value: "Dolor/Urgencia" },
            { label: "Otro", value: "Otro" },
          ]);
          append("¬øQu√© servicio necesitas o qu√© problema tienes?", "bot", "rc/ai");
          return;
        }
        if (state.step === 1) {
          state.data.servicio = normalized;
          state.step = 2;
          renderQuickReplies([
            { label: "Hoy", value: "Hoy" },
            { label: "Ma√±ana", value: "Ma√±ana" },
            { label: "Esta semana", value: "Esta semana" },
            { label: "Fecha espec√≠fica", value: "Fecha espec√≠fica" },
          ]);
          append("¬øQu√© d√≠a prefieres? (puedes escribir YYYY-MM-DD)", "bot", "rc/ai");
          return;
        }
        if (state.step === 2) {
          state.data.fecha = normalized;
          state.step = 3;
          renderQuickReplies([
            { label: "09:00 ‚Äì 09:30", value: "09:00 ‚Äì 09:30" },
            { label: "09:30 ‚Äì 10:00", value: "09:30 ‚Äì 10:00" },
            { label: "11:00 ‚Äì 11:30", value: "11:00 ‚Äì 11:30" },
            { label: "16:00 ‚Äì 16:30", value: "16:00 ‚Äì 16:30" },
            { label: "17:00 ‚Äì 17:30", value: "17:00 ‚Äì 17:30" },
          ]);
          append("Estos son los horarios base (se confirman en recepci√≥n). Elige uno o escribe tu preferido:", "bot", "rc/ai");
          return;
        }
        if (state.step === 3) {
          state.data.hora = normalized;
          state.step = 4;
          renderQuickReplies([]);
          append("Comparte nombre y tel√©fono (WhatsApp) en un mensaje, ejemplo: Juan P√©rez, 55 1234 5678", "bot", "rc/ai");
          return;
        }
        if (state.step === 4) {
          const [nombre, telefono] = normalized.split(",").map(x => x?.trim()).filter(Boolean);
          state.data.nombre = nombre || normalized;
          state.data.telefono = telefono || "";
          state.step = 5;
          const folio = genFolio();
          state.data.folio = folio;
          append(`Confirma tu cita:\nServicio: ${state.data.servicio || "N/D"}\nPaciente: ${state.data.paciente || "N/D"}\nFecha: ${state.data.fecha || "N/D"}\nHora: ${state.data.hora || "N/D"}\nNombre: ${state.data.nombre || "N/D"}\nTel: ${state.data.telefono || "N/D"}\nFolio: ${folio}`, "bot", "rc/ai");
          renderQuickReplies([
            { label: "‚úÖ Confirmar", value: "Confirmar" },
            { label: "‚Ü©Ô∏è Cambiar", value: "Cambiar" },
            { label: "Men√∫", value: "men√∫" },
          ]);
          return;
        }
        if (state.step === 5) {
          if (normalized.toLowerCase().includes("confirm")) {
            append("Cita registrada ‚úÖ. Recepci√≥n confirmar√° en breve. ¬øTe ayudo con algo m√°s?", "bot", "rc/ai");
            resetFlow();
            return;
          }
          if (normalized.toLowerCase().includes("cambiar")) {
            state.step = 0;
            renderQuickReplies([
              { label: "Nuevo", value: "Nuevo" },
              { label: "Ya soy paciente", value: "Ya soy paciente" },
            ]);
            append("Reiniciemos el registro. ¬øEres paciente nuevo o ya te atendiste con nosotros?", "bot", "rc/ai");
            return;
          }
        }
      }

      if (flow === "servicios") {
        if (state.step === 0) {
          state.data.servicio = normalized;
          const rangos = {
            Limpieza: "$800 - $1,200 (incluye revisi√≥n)",
            Resina: "$1,200 - $2,000 por pieza",
            Extracci√≥n: "$1,500 - $3,000 (seg√∫n complejidad)",
            Endodoncia: "$3,500 - $5,500 por molar",
            Brackets: "$8,000 - $15,000 inicial",
            Blanqueamiento: "$2,500 - $4,000",
            Dolor: "Valoraci√≥n prioritaria (se cotiza en consulta)",
            Otro: "Se cotiza en valoraci√≥n",
          };
          const rango = rangos[state.data.servicio] || "Te doy el rango en valoraci√≥n";
          append(`Estimado aproximado para ${state.data.servicio}: ${rango}.\nEsto es un estimado, se confirma en consulta. ¬øQuieres agendar una valoraci√≥n?`, "bot", "rc/ai");
          renderQuickReplies([
            { label: "S√≠, agendar", value: "S√≠, agendar" },
            { label: "No por ahora", value: "No por ahora" },
            { label: "Men√∫", value: "men√∫" },
          ]);
          state.step = 1;
          return;
        }
        if (state.step === 1) {
          if (normalized.toLowerCase().includes("s√≠")) {
            append("Perfecto, vamos a agendar.", "bot", "rc/ai");
            state.flow = "agendar";
            state.step = 0;
            renderQuickReplies([
              { label: "Nuevo", value: "Nuevo" },
              { label: "Ya soy paciente", value: "Ya soy paciente" },
            ]);
            append("¬øEres paciente nuevo o ya te atendiste con nosotros?", "bot", "rc/ai");
            return;
          }
          append("Entendido. Si necesitas algo m√°s, dime.", "bot", "rc/ai");
          resetFlow();
          return;
        }
      }

      if (flow === "urgencias") {
        if (state.step === 0) {
          state.data.resp1 = normalized;
          state.step = 1;
          append("¬øHay sangrado que no se detiene?", "bot", "rc/ai");
          return;
        }
        if (state.step === 1) {
          state.data.resp2 = normalized;
          state.step = 2;
          append("¬øFue un golpe o trauma dental reciente?", "bot", "rc/ai");
          return;
        }
        if (state.step === 2) {
          append("Podr√≠a ser urgente. Te recomiendo contactar a recepci√≥n ahora.", "bot", "rc/ai");
          append("Si hay fiebre alta o dificultad para respirar, acude a urgencias m√©dicas.", "bot", "rc/ai");
          renderQuickReplies([
            { label: "WhatsApp", value: "https://wa.me/523228892558" },
            { label: "Llamar", value: "tel:+523228892558" },
            { label: "Agendar valoraci√≥n", value: "Agendar valoraci√≥n" },
            { label: "Men√∫", value: "men√∫" },
          ]);
          state.step = 3;
          return;
        }
        if (state.step === 3) {
          if (normalized.toLowerCase().includes("agenda")) {
            state.flow = "agendar";
            state.step = 0;
            renderQuickReplies([
              { label: "Nuevo", value: "Nuevo" },
              { label: "Ya soy paciente", value: "Ya soy paciente" },
            ]);
            append("¬øEres paciente nuevo o ya te atendiste con nosotros?", "bot", "rc/ai");
            return;
          }
          resetFlow();
          return;
        }
      }

      if (flow === "ubicacion") {
        append("üìç Calle Guatemala #125, El Pitillal, Puerto Vallarta\nüïí Horario: Lunes 7am-7pm, S√°bado 9am-2pm\n‚û°Ô∏è Google Maps: https://www.google.com/maps?q=Calle%20Guatemala%20125%20El%20Pitillal%20Puerto%20Vallarta", "bot", "rc/ai");
        resetFlow();
        return;
      }

      if (flow === "pagos") {
        append("üí≥ Pagos: efectivo, transferencia y tarjeta.\nüßæ Facturaci√≥n: disponible, solicitaremos RFC, correo y uso de CFDI.\n¬øNecesitas agendar o m√°s detalles?", "bot", "rc/ai");
        resetFlow();
        return;
      }

      if (flow === "humano") {
        if (state.step === 0) {
          state.step = 1;
          append("Claro, te paso con recepci√≥n. Comparte tu nombre y tel√©fono:", "bot", "rc/ai");
          renderQuickReplies([]);
          return;
        }
        if (state.step === 1) {
          append("Listo ‚úÖ Recepci√≥n te contactar√° lo antes posible.", "bot", "rc/ai");
          resetFlow();
          return;
        }
      }
    };

    const startFlow = (flow) => {
      state.flow = flow;
      state.step = 0;
      state.data = {};
      if (flow === "agendar") {
        renderQuickReplies([
          { label: "Nuevo", value: "Nuevo" },
          { label: "Ya soy paciente", value: "Ya soy paciente" },
        ]);
        append("¬øEres paciente nuevo o ya te atendiste con nosotros?", "bot", "rc/ai");
        return;
      }
      if (flow === "servicios") {
        renderQuickReplies([
          { label: "Limpieza", value: "Limpieza" },
          { label: "Resina", value: "Resina" },
          { label: "Extracci√≥n", value: "Extracci√≥n" },
          { label: "Endodoncia", value: "Endodoncia" },
          { label: "Brackets", value: "Brackets" },
          { label: "Blanqueamiento", value: "Blanqueamiento" },
          { label: "Dolor/Urgencia", value: "Dolor/Urgencia" },
          { label: "Otro", value: "Otro" },
        ]);
        append("Te puedo dar un rango aproximado. El precio final depende de valoraci√≥n. ¬øQu√© servicio te interesa?", "bot", "rc/ai");
        return;
      }
      if (flow === "urgencias") {
        append("¬øTienes hinchaz√≥n o dolor muy fuerte (8/10)?", "bot", "rc/ai");
        state.step = 0;
        renderQuickReplies([
          { label: "S√≠", value: "S√≠" },
          { label: "No", value: "No" },
        ]);
        return;
      }
      if (flow === "ubicacion") {
        handleFlow("");
        return;
      }
      if (flow === "pagos") {
        handleFlow("");
        return;
      }
      if (flow === "humano") {
        handleFlow("");
        return;
      }
    };

    const sendToBackend = async (text) => {
      const loader = append("...", "bot", null, true);
      try {
        const resp = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query: text })
        });
        const data = await resp.json().catch(() => ({}));
        loader.remove();
        const mensajes = Array.isArray(data.messages) && data.messages.length
          ? data.messages
          : [data.message || t.error];
        mensajes.forEach(msg => append(msg, "bot", data.source));
      } catch (err) {
        loader.remove();
        append(t.error, "bot");
      }
    };

    const handleInput = (text) => {
      if (!text.trim()) return;
      if (isMenuCommand(text)) {
        resetFlow();
        append("Men√∫ principal listo. ¬øQu√© necesitas hoy?", "bot", "rc/ai");
        return;
      }
      append(text, "user");

      if (state.flow) {
        handleFlow(text);
      } else {
        sendToBackend(text);
      }
    };

    const openChat = () => {
      chat.style.display = "flex";
      if (scrim) { scrim.style.opacity = "1"; scrim.style.pointerEvents = "auto"; }
      input.focus();
      if (!messages.dataset.seeded) {
        append(t.greeting, "bot", "rc/ai");
        append("Selecciona una opci√≥n para avanzar m√°s r√°pido:", "bot", "rc/ai");
        setMenu();
        messages.dataset.seeded = "1";
      }
    };
    const closeChat = () => {
      chat.style.display = "none";
      if (scrim) { scrim.style.opacity = "0"; scrim.style.pointerEvents = "none"; }
    };

    toggle.addEventListener("click", openChat);
    if (scrim) scrim.addEventListener("click", closeChat);
    closeBtn.addEventListener("click", closeChat);

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = input.value.trim();
      input.value = "";
      handleInput(text);
    });

    document.getElementById("rc-quick-replies").addEventListener("click", (e) => {
      if (e.target && e.target.classList.contains("rc-chip")) {
        const flow = e.target.dataset.flow;
        const msg = e.target.dataset.msg || e.target.textContent;
        if (flow) {
          startFlow(flow);
        } else if (msg.startsWith("http")) {
          window.open(msg, "_blank");
        } else {
          handleInput(msg);
        }
      }
    });

    quicks.forEach(btn => {
      btn.addEventListener("click", () => {
        const text = btn.dataset.msg || "";
        if (!text) return;
        handleInput(text);
      });
    });
  })();
</script>
{% endblock %}
