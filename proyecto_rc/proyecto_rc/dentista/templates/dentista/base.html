{% extends "_components/base_site.html" %}
{% load static %}

{# T√≠tulo de la pesta√±a (no duplica dtitle) #}
{% block title %}√Årea Dentista{% endblock %}

{# Solo enlazamos tu CSS del m√≥dulo, sin overrides inline #}
{% block head_extra %}
  <link rel="stylesheet" href="{% static 'dentista/styles.css' %}">
{% endblock %}

{% block content %}
<div class="layout">
  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar" role="navigation" aria-label="Men√∫ principal">
    <h2 class="sidebar-title">Dentista</h2>
    <nav class="sidebar-nav">
      <ul>
        <li>
          <a href="{% url 'dentista:dashboard' %}">
            <!-- icono dashboard -->
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" fill="currentColor"/>
            </svg>
            <span>Dashboard</span>
          </a>
        </li>
        <li>
          <a href="{% url 'dentista:agenda' %}">
            <!-- icono calendario -->
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M7 2v2H5a2 2 0 0 0-2 2v2h18V6a2 2 0 0 0-2-2h-2V2h-2v2H9V2H7zm14 8H3v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V10z" fill="currentColor"/>
            </svg>
            <span>Agenda</span>
          </a>
        </li>
        <li>
          <a href="{% url 'dentista:pacientes' %}">
            <!-- icono usuarios -->
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zM8 11c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0-.62.02-.97.06 1.16.84 1.97 1.95 1.97 3.44V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" fill="currentColor"/>
            </svg>
            <span>Pacientes</span>
          </a>
        </li>
      </ul>
    </nav>
  </aside>

  <!-- Contenedor principal -->
  <div class="content-wrap">
    <header class="topbar">
      <!-- Bot√≥n hamburguesa (solo m√≥vil) -->
      <button id="burgerBtn" class="burger" aria-label="Abrir men√∫" aria-controls="sidebar" aria-expanded="false">
        <svg width="24" height="24" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z" fill="currentColor"/>
        </svg>
      </button>
      <h2 class="page-title">{% block dtitle %}{% endblock %}</h2>
    </header>

    <main class="main-content">
      {% block dcontent %}{% endblock %}
    </main>

    <footer class="site-footer">
      ¬© 2025 Consultorio ‚ÄúRodolfo Castell√≥n‚Äù. Todos los derechos reservados.
    </footer>
  </div>
</div>

<!-- Backdrop para el drawer m√≥vil -->
<div id="backdrop" class="backdrop" hidden></div>

<!-- JS m√≠nimo para abrir/cerrar el drawer y resaltar link activo -->
<script>
  (function () {
    const sidebar  = document.getElementById('sidebar');
    const burger   = document.getElementById('burgerBtn');
    const backdrop = document.getElementById('backdrop');

    function toggleDrawer(open) {
      const willOpen = (typeof open === 'boolean') ? open : !sidebar.classList.contains('open');
      sidebar.classList.toggle('open', willOpen);
      backdrop.hidden = !willOpen;
      burger.setAttribute('aria-expanded', String(willOpen));
      document.documentElement.classList.toggle('no-scroll', willOpen);
    }

    if (burger) burger.addEventListener('click', () => toggleDrawer());
    if (backdrop) backdrop.addEventListener('click', () => toggleDrawer(false));
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') toggleDrawer(false); });

    // Marcar link activo seg√∫n URL
    const here = window.location.pathname.replace(/\/$/, '');
    document.querySelectorAll('.sidebar-nav a').forEach(a => {
      const href = a.getAttribute('href')?.replace(/\/$/, '');
      if (href && (here === href || (here.startsWith(href) && href !== '/'))) {
        a.classList.add('is-active');
      }
    });

    // Cerrar drawer si redimensiona a desktop
    const mq = window.matchMedia('(min-width: 1024px)');
    mq.addEventListener('change', (e) => { if (e.matches) toggleDrawer(false); });
  })();
</script>

<!-- ========== ASISTENTE IA (Frontend puro) ========== -->
<button id="aiFab" class="ai-fab" aria-label="Abrir asistente IA">IA</button>

<aside id="aiDock" class="ai-dock" aria-hidden="true">
  <header class="ai-head">
    <strong>Asistente IA</strong>
    <button id="aiClose" class="ai-icon" aria-label="Cerrar">‚úï</button>
  </header>

  <div id="aiBody" class="ai-body" role="log" aria-live="polite">
    <div class="ai-tip">
      üëã Puedo resumir lo que ves en pantalla (Agenda, Dashboard o Pacientes).
      Prueba con:
    </div>
    <div class="ai-suggests">
      <button class="ai-chip" data-q="Resume mi agenda de hoy.">Resume mi agenda de hoy</button>
      <button class="ai-chip" data-q="¬øQu√© huecos libres tengo entre 10:00 y 12:00?">Huecos 10‚Äì12</button>
      <button class="ai-chip" data-q="Pacientes con saldo pendiente.">Saldos pendientes</button>
    </div>
  </div>

  <form id="aiForm" class="ai-form" autocomplete="off">
    <input id="aiInput" class="ai-input" name="q" placeholder="Escribe tu consulta‚Ä¶ (Enter para enviar)" />
    <button class="ai-send" aria-label="Enviar">‚û§</button>
  </form>
</aside>

<style>
/* ====== estilos m√≠nimos del widget IA (aislados) ====== */
.ai-fab{position:fixed;right:18px;bottom:18px;border:1px solid rgba(127,127,127,.35);background:transparent;color:inherit;
  border-radius:999px;padding:.7rem 1rem;font-weight:700;box-shadow:0 8px 24px rgba(0,0,0,.15);z-index:60}
.ai-dock{position:fixed;right:18px;bottom:18px;top:18px;width:min(420px,92vw);background:transparent;
  border:1px solid rgba(127,127,127,.25);border-radius:1rem;display:flex;flex-direction:column;
  transform:translateY(calc(100% + 18px));transition:transform .25s ease;z-index:61;backdrop-filter:blur(6px)}
.ai-dock[aria-hidden="false"]{transform:translateY(0)}
.ai-head{display:flex;align-items:center;justify-content:space-between;padding:.8rem 1rem;border-bottom:1px solid rgba(127,127,127,.25)}
.ai-icon{border:1px solid rgba(127,127,127,.25);background:transparent;border-radius:.6rem;padding:.35rem .55rem}
.ai-body{padding:1rem;display:flex;flex-direction:column;gap:.6rem;overflow:auto;max-height:65vh}
.ai-tip{opacity:.8;font-size:.9rem}
.ai-suggests{display:flex;flex-wrap:wrap;gap:.4rem}
.ai-chip{border:1px solid rgba(127,127,127,.35);background:transparent;border-radius:999px;padding:.35rem .6rem;font-size:.85rem}
.ai-msg{border:1px solid rgba(127,127,127,.25);border-radius:.7rem;padding:.55rem .7rem;white-space:pre-wrap}
.ai-msg.user{background:rgba(59,130,246,.08);border-color:rgba(59,130,246,.35)}
.ai-msg.bot{background:rgba(34,197,94,.08);border-color:rgba(34,197,94,.35)}
.ai-form{display:flex;gap:.5rem;padding:.8rem 1rem;border-top:1px solid rgba(127,127,127,.25)}
.ai-input{flex:1;border:1px solid rgba(127,127,127,.35);border-radius:.6rem;background:transparent;color:inherit;padding:.5rem .6rem}
.ai-send{border:1px solid rgba(127,127,127,.35);background:transparent;border-radius:.6rem;padding:.5rem .7rem}
@media (max-width:720px){.ai-dock{top:auto;height:72vh}}
</style>

<script>
/* ====== L√≥gica IA 100% frontend (sin red) ======
   Lee el DOM de cada vista y produce un resumen.
   Soporta:
   - Agenda: tabla .ag-table y tablero semanal
   - Dashboard: tabla .dx-table
   - Pacientes: tabla .pt-table
*/
(function(){
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  const aiFab   = $('#aiFab');
  const aiDock  = $('#aiDock');
  const aiClose = $('#aiClose');
  const aiBody  = $('#aiBody');
  const aiForm  = $('#aiForm');
  const aiInput = $('#aiInput');

  function openDock(){ aiDock.setAttribute('aria-hidden','false'); aiInput?.focus(); }
  function closeDock(){ aiDock.setAttribute('aria-hidden','true'); }
  function appendMsg(role, text){
    const el = document.createElement('div');
    el.className = 'ai-msg ' + (role === 'user' ? 'user' : 'bot');
    el.textContent = text;
    aiBody.appendChild(el);
    aiBody.scrollTop = aiBody.scrollHeight;
  }

  // Heur√≠stica para saber en qu√© vista estamos
  function view(){
    if ($('.ag-scope')) return 'agenda';
    if ($('.dx-scope')) return 'dashboard';
    if ($('.pt-scope')) return 'pacientes';
    return 'otro';
  }

  // Parsers por vista (DOM -> datos)
  function parseAgenda(){
    // Usa la tabla del d√≠a si existe
    const rows = $$('.ag-table tbody tr').map(tr=>{
      const tds = tr.querySelectorAll('td');
      return {
        hora: tds[0]?.textContent.trim(),
        paciente: tds[1]?.textContent.trim(),
        motivo: tds[2]?.textContent.trim(),
        estado: tds[3]?.innerText.trim().toLowerCase(),
        pago:   tds[4]?.innerText.trim().toLowerCase()
      };
    });
    return { rows };
  }

  function parseDashboard(){
    const rows = $$('.dx-table tbody tr').map(tr=>{
      const t = tr.querySelectorAll('td');
      return {
        hora: t[0]?.textContent.trim(),
        paciente: t[1]?.textContent.trim(),
        motivo: t[2]?.textContent.trim(),
        estado: t[3]?.innerText.trim().toLowerCase(),
        pago:   t[4]?.innerText.trim().toLowerCase()
      };
    });
    return { rows };
  }

  function parsePacientes(){
    const rows = $$('.pt-table tbody tr').map(tr=>{
      const t = tr.querySelectorAll('td');
      const nombre = tr.querySelector('.pt-name')?.textContent.trim() || t[0]?.textContent.trim();
      const estado = tr.querySelector('.pt-badge')?.innerText.trim().toLowerCase();
      const saldoTxt = tr.querySelector('.pt-saldo')?.innerText.trim() || '';
      // Normaliza saldo a n√∫mero si fuese posible
      const saldo = (saldoTxt.match(/[\d,.]+/)||['0'])[0];
      const saldoNum = Number(saldo.replace(/[^\d.]/g,'')||0);
      return {
        paciente: nombre,
        edad: t[1]?.textContent.trim(),
        contacto: t[2]?.textContent.trim(),
        ultima: t[3]?.textContent.trim(),
        estado, saldoTxt, saldoNum
      };
    });
    return { rows };
  }

  // Generador de respuestas (pseudo-IA local)
  function generateAnswer(q){
    const v = view();
    const ql = (q||'').toLowerCase();

    if (v==='agenda' || (v==='dashboard' && ql.includes('agenda'))) {
      const { rows } = v==='agenda' ? parseAgenda() : parseDashboard();
      const total = rows.length;
      const pend = rows.filter(r=>r.estado.includes('pendiente')).length;
      const sala = rows.filter(r=>r.estado.includes('sala')).length;
      const ok   = rows.filter(r=>r.estado.includes('atendido')).length;
      const cancel = rows.filter(r=>r.estado.includes('cancel')).length;

      if (ql.includes('huecos') || ql.includes('libres')) {
        // Huecos entre 10:00 y 12:00 si se pidi√≥
        const rango = (ql.match(/(\d{1,2}:\d{2}).*(\d{1,2}:\d{2})/)||[]).slice(1);
        const start = rango[0] || '10:00';
        const end   = rango[1] || '12:00';
        const horasOcupadas = new Set(rows.map(r=>r.hora).filter(Boolean));
        const slots = ['09:00','09:30','10:00','10:30','11:00','11:30','12:00','12:30','13:00','13:30'];
        const ventana = slots.filter(h => h >= start && h <= end);
        const libres = ventana.filter(h => !horasOcupadas.has(h));
        return `üóìÔ∏è Huecos entre ${start} y ${end}:\n` +
               (libres.length ? '‚Ä¢ ' + libres.join('\n‚Ä¢ ') : 'No hay huecos en ese rango.') +
               `\n\n(Estimaci√≥n local seg√∫n la tabla visible)`;
      }

      if (ql.includes('resum')) {
        // Resumen general
        const proxima = rows[0]?.hora && rows[0]?.paciente ? `${rows[0].hora} ¬∑ ${rows[0].paciente}` : '‚Äî';
        return `Resumen de agenda (local):\n` +
               `‚Ä¢ Total: ${total}\n` +
               `‚Ä¢ Pendientes: ${pend}\n` +
               `‚Ä¢ En sala: ${sala}\n` +
               `‚Ä¢ Atendidas: ${ok}\n` +
               `‚Ä¢ Canceladas: ${cancel}\n` +
               `‚Ä¢ Pr√≥xima: ${proxima}`;
      }

      if (ql.includes('pago') || ql.includes('cobro') || ql.includes('saldo')) {
        const porCobrar = rows.filter(r=>r.pago.includes('pendiente')).map(r=>`- ${r.hora} ¬∑ ${r.paciente}`);
        return porCobrar.length
          ? `üí∞ Por cobrar hoy:\n${porCobrar.join('\n')}`
          : 'No encuentro cobros pendientes visibles en la tabla.';
      }

      // Por defecto
      return `Puedo resumir la agenda visible (total, estados, pr√≥xima cita) o buscar huecos por rango de hora. Dime "Resume mi agenda" o "Huecos 10:00 a 12:00".`;
    }

    if (v==='pacientes') {
      const { rows } = parsePacientes();
      const total = rows.length;
      const conSaldo = rows.filter(r=>r.saldoNum>0);
      const saldoTotal = conSaldo.reduce((a,b)=>a+b.saldoNum,0);
      if (ql.includes('saldo') || ql.includes('pago') || ql.includes('cobro')) {
        const lista = conSaldo.map(r=>`- ${r.paciente}: ${r.saldoTxt}`).join('\n');
        return `üë• Pacientes con saldo (visible): ${conSaldo.length}\n` +
               `Total estimado: $ ${saldoTotal.toLocaleString()}\n` +
               (lista ? `\n${lista}` : '');
      }
      if (ql.includes('resum')) {
        const activos = rows.filter(r=>r.estado.includes('activo')).length;
        const nuevos = rows.filter(r=>r.estado.includes('nuevo')).length;
        const trat = rows.filter(r=>r.estado.includes('tratamiento')).length;
        const inact = rows.filter(r=>r.estado.includes('inactivo')).length;
        return `Resumen de pacientes (local):\n` +
               `‚Ä¢ Total listado: ${total}\n` +
               `‚Ä¢ Activos: ${activos} ¬∑ Nuevos: ${nuevos}\n` +
               `‚Ä¢ En tratamiento: ${trat} ¬∑ Inactivos: ${inact}\n` +
               `‚Ä¢ Con saldo: ${conSaldo.length}`;
      }
      return `Puedo listar pacientes con saldo, o darte un resumen del listado visible. Prueba: "Pacientes con saldo pendiente" o "Resume pacientes".`;
    }

    // Vista no reconocida
    return 'Abre Agenda, Dashboard o Pacientes para que pueda leer la informaci√≥n visible y ayudarte üôÇ';
  }

  // Interacci√≥n
  aiFab?.addEventListener('click', openDock);
  aiClose?.addEventListener('click', closeDock);
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDock(); });

  // Sugerencias (chips)
  aiBody?.addEventListener('click', (e)=>{
    const b = e.target.closest('.ai-chip');
    if(!b) return;
    aiInput.value = b.dataset.q || '';
    aiInput.focus();
  });

  aiForm?.addEventListener('submit', (e)=>{
    e.preventDefault();
    const q = aiInput.value.trim();
    if(!q) return;
    appendMsg('user', q);
    aiInput.value = '';
    const a = generateAnswer(q);
    appendMsg('bot', a);
  });
})();
</script>
{% endblock %}
