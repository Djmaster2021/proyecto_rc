{% extends "paciente/base.html" %}
{% load static %}

{% block ptitle %}Dashboard del Paciente{% endblock %}

{% block pcontent %}
  <section class="cyber-banner">
    <h1 class="cyber-title">Bienvenido, Ana</h1>
    <p class="cyber-subtitle">Tu salud dental en tus manos. Aquí puedes gestionar tus citas y ver tu historial.</p>
    <div class="cyber-actions">
      <button id="btn-agendar" class="cyber-btn cyber-btn-glow">Agendar una nueva cita</button>
      <button id="btn-reprogramar" class="cyber-btn">Reprogramar próxima cita</button>
      <button id="btn-cancelar" class="cyber-btn cyber-btn-danger">Cancelar próxima cita</button>
    </div>
  </section>

  <div class="page-container">
    <div class="grid-cols-2">
      <div class="glow-card-wrapper">
        <div class="cyber-card">
          <h2 class="card-title">Tu Próxima Cita</h2>
          <div id="proxima-cita-content">
            </div>
        </div>
      </div>

      <div class="glow-card-wrapper">
        <div class="cyber-card">
          <h2 class="card-title">Mi Perfil</h2>
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <label for="perfil-foto-input-main" style="cursor: pointer;">
              <img id="perfil-img" src="https://placehold.co/80x80/007bff/ffffff?text=AP" alt="Foto de perfil" style="border-radius: 50%; border: 2px solid var(--color-primary); width: 30mm; height: 25mm; object-fit: cover;">
              <input type="file" id="perfil-foto-input-main" accept="image/*" style="display: none;">
            </label>
            <div>
              <p><strong>ID de Paciente:</strong> <span id="perfil-id">RC-0012345</span></p>
              <p><strong>Nombre:</strong> <span id="perfil-nombre-view">Ana López</span></p>
              <p><strong>Email:</strong> <span id="perfil-email-view">ana@example.com</span></p>
            </div>
          </div>
          <p><strong>Teléfono:</strong> <span id="perfil-telefono-view">+52 55 1234 5678</span></p>
          <p><strong>Dirección:</strong> <span id="perfil-direccion-view">Calle de la Paz #123, Colonia Centro</span></p>
          <div style="margin-top: 1.5rem;">
            <button id="btn-editar-perfil" class="cyber-btn">Editar Perfil</button>
            <button id="btn-cambiar-password" class="cyber-btn">Cambiar Contraseña</button>
          </div>
        </div>
      </div>
    </div>

    <section class="glow-card-wrapper" style="margin-top: 1.5rem;">
      <div class="cyber-card">
        <h2 class="card-title">Historial de Citas</h2>
        <div class="table-responsive">
          <table class="data-table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Motivo</th>
                <th>Estado</th>
                <th>Pagos</th>
              </tr>
            </thead>
            <tbody id="historial-citas-tbody">
              </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <div id="modal-agendar" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Agendar Nueva Cita</h3>
        <button class="modal-close">&times;</button>
      </div>
      <form id="form-agendar">
        <div class="form-group">
          <label for="agendar-fecha">Fecha</label>
          <input type="date" id="agendar-fecha" required>
        </div>
        <div class="form-group">
          <label for="agendar-hora">Hora</label>
          <input type="time" id="agendar-hora" required>
        </div>
        <div class="form-group">
          <label for="agendar-motivo">Motivo</label>
          <input type="text" id="agendar-motivo" placeholder="Ej: Limpieza, endodoncia..." required>
        </div>
        <div class="form-actions">
          <button type="button" class="cyber-btn modal-close">Cancelar</button>
          <button type="submit" class="cyber-btn">Agendar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="modal-reprogramar" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Reprogramar Cita</h3>
        <button class="modal-close">&times;</button>
      </div>
      <p>⚠️ Ten en cuenta que solo puedes reprogramar tu cita una vez. Para futuras reprogramaciones, por favor contacta directamente a tu dentista.</p>
      <form id="form-reprogramar">
        <div class="form-group">
          <label for="reprogramar-fecha">Nueva Fecha</label>
          <input type="date" id="reprogramar-fecha" required>
        </div>
        <div class="form-group">
          <label for="reprogramar-hora">Nueva Hora</label>
          <input type="time" id="reprogramar-hora" required>
        </div>
        <div class="form-actions">
          <button type="button" class="cyber-btn modal-close">Cancelar</button>
          <button type="submit" class="cyber-btn">Reprogramar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="modal-cancelar" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Confirmar Cancelación</h3>
        <button class="modal-close">&times;</button>
      </div>
      <p>¿Estás segura de que deseas cancelar tu próxima cita?</p>
      <div class="form-actions">
        <button type="button" class="cyber-btn modal-close">No, mantener</button>
        <button type="button" class="cyber-btn cyber-btn-danger" id="confirmar-cancelar">Sí, cancelar</button>
      </div>
    </div>
  </div>

  <div id="modal-perfil" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Editar Perfil</h3>
        <button class="modal-close">&times;</button>
      </div>
      <form id="form-perfil">
        <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-bottom: 1rem;">
          <img id="perfil-img-modal" src="https://placehold.co/30x25/007bff/ffffff?text=AP" alt="Foto de perfil" style="width: 30mm; height: 25mm; border-radius: 50%; border: 2px solid var(--color-primary); object-fit: cover;">
          <div style="display: flex; gap: 0.5rem;">
            <label for="perfil-foto-input-modal" class="cyber-btn cyber-btn--sm" style="cursor: pointer;">Subir foto</label>
            <button type="button" id="btn-eliminar-foto" class="cyber-btn cyber-btn-danger cyber-btn--sm">Eliminar</button>
          </div>
          <input type="file" id="perfil-foto-input-modal" accept="image/*" style="display: none;">
        </div>
        <p><strong>ID de Paciente:</strong> <span id="perfil-id-modal">RC-0012345</span></p>
        <div class="form-group">
          <label for="perfil-nombre">Nombre</label>
          <input type="text" id="perfil-nombre" value="Ana López" required>
        </div>
        <div class="form-group">
          <label for="perfil-email">Email</label>
          <input type="email" id="perfil-email" value="ana@example.com" required>
        </div>
        <div class="form-group">
          <label for="perfil-tel">Teléfono</label>
          <input type="tel" id="perfil-tel" value="+52 55 1234 5678" required>
        </div>
        <div class="form-group">
          <label for="perfil-direccion">Dirección</label>
          <input type="text" id="perfil-direccion" value="Calle de la Paz #123, Colonia Centro" required>
        </div>
        <div class="form-actions">
          <button type="button" class="cyber-btn modal-close">Cancelar</button>
          <button type="submit" class="cyber-btn">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>

  <div id="modal-cambiar-password" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Cambiar Contraseña</h3>
        <button class="modal-close">&times;</button>
      </div>
      <p>⚠️ Solo puedes cambiar tu contraseña cada 3 meses. Esto es para tu seguridad.</p>
      <form id="form-cambiar-password">
        <div class="form-group">
          <label for="password-actual">Contraseña Actual</label>
          <input type="password" id="password-actual" required>
        </div>
        <div class="form-group">
          <label for="password-nueva">Nueva Contraseña</label>
          <input type="password" id="password-nueva" required>
        </div>
        <div class="form-group">
          <label for="password-confirmar">Confirmar Nueva Contraseña</label>
          <input type="password" id="password-confirmar" required>
        </div>
        <div class="form-actions">
          <button type="button" class="cyber-btn modal-close">Cancelar</button>
          <button type="submit" class="cyber-btn">Cambiar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="modal-custom-alert" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="custom-alert-title"></h3>
        <button class="modal-close">&times;</button>
      </div>
      <p id="custom-alert-message"></p>
      <div class="form-actions">
        <button type="button" class="cyber-btn modal-close">OK</button>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      "use strict";

      // Helpers
      const $ = (s, r = document) => r.querySelector(s);
      const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));

      // ===== Estado Global (usando localStorage) =====
      const LS_PROXIMA_CITA = 'rc_proxima_cita';
      const LS_HISTORIAL = 'rc_historial_citas';
      const LS_REPROG_COUNT = 'rc_reprog_count';
      const LS_LAST_PW_CHANGE = 'rc_last_pw_change';
      const LS_PROFILE_PHOTO = 'rc_profile_photo';
      const LS_THEME = 'rc_theme';
      
      // Datos de perfil y cita iniciales
      const initialState = {
        perfil: {
          id: 'RC-0012345',
          nombre: 'Ana López',
          email: 'ana@example.com',
          telefono: '+52 55 1234 5678',
          direccion: 'Calle de la Paz #123, Colonia Centro',
          foto: 'https://placehold.co/80x80/007bff/ffffff?text=AP'
        },
        proximaCita: null, // Inicialmente no hay cita
        historial: [
          { fecha: '2025-08-10', motivo: 'Consulta de ortodoncia', estado: 'Atendida', pago: '500.00' },
          { fecha: '2025-07-10', motivo: 'Valoración de tratamiento', estado: 'Atendida', pago: '200.00' },
          { fecha: '2025-06-10', motivo: 'Limpieza dental', estado: 'Cancelada', pago: '-' }
        ]
      };

      // Cargar/guardar estado
      function getProx() {
        try {
          const item = localStorage.getItem(LS_PROXIMA_CITA);
          return item ? JSON.parse(item) : initialState.proximaCita;
        } catch { return initialState.proximaCita; }
      }
      function setProx(cita) { localStorage.setItem(LS_PROXIMA_CITA, JSON.stringify(cita)); }

      function getHistorial() {
        try {
          const item = localStorage.getItem(LS_HISTORIAL);
          return item ? JSON.parse(item) : initialState.historial;
        } catch { return initialState.historial; }
      }
      function setHistorial(historial) { localStorage.setItem(LS_HISTORIAL, JSON.stringify(historial)); }

      function getReprogCount() {
        return parseInt(localStorage.getItem(LS_REPROG_COUNT) || '0');
      }
      function setReprogCount(count) {
        localStorage.setItem(LS_REPROG_COUNT, count);
      }

      function getLastPwChange() {
        return parseInt(localStorage.getItem(LS_LAST_PW_CHANGE) || '0');
      }
      function setLastPwChange(timestamp) {
        localStorage.setItem(LS_LAST_PW_CHANGE, timestamp);
      }

      function getTheme() {
        return localStorage.getItem(LS_THEME) || 'light';
      }
      function setTheme(theme) {
        localStorage.setItem(LS_THEME, theme);
      }

      function getProfilePhoto() {
        return localStorage.getItem(LS_PROFILE_PHOTO) || initialState.perfil.foto;
      }
      function setProfilePhoto(photoDataUrl) {
        localStorage.setItem(LS_PROFILE_PHOTO, photoDataUrl);
      }
      
      const isoToday = new Date().toISOString().slice(0, 10);
      const festiveDates = ["2025-12-25", "2026-01-01"]; 

      const prettyDate = (iso) => {
        if (!iso) return "—";
        const [y, m, d] = iso.split("-").map(Number);
        return new Date(y, m - 1, d).toLocaleDateString("es-MX", { day: "2-digit", month: "long", year: "numeric" });
      };

      // Renderizar UI
      function render() {
        const proxCita = getProx();
        const historial = getHistorial();
        const btnAgendar = $('#btn-agendar');

        // Renderizar próxima cita
        const proxCitaContainer = $('#proxima-cita-content');
        if (proxCita) {
          proxCitaContainer.innerHTML = `
            <p><strong>Fecha:</strong> ${prettyDate(proxCita.fecha)}</p>
            <p><strong>Hora:</strong> ${proxCita.hora}</p>
            <p><strong>Motivo:</strong> ${proxCita.motivo}</p>
            <p><strong>Consultorio:</strong> ${proxCita.consultorio}</p>
            <p>
              <strong>Estado:</strong>
              <span class="chip status-${proxCita.estado.toLowerCase()}">${proxCita.estado}</span>
            </p>
          `;
          $('#btn-reprogramar').style.display = 'inline-flex';
          $('#btn-cancelar').style.display = 'inline-flex';
          if (btnAgendar) { btnAgendar.style.display = 'none'; }
        } else {
          proxCitaContainer.innerHTML = '<p>No tienes una cita próxima agendada.</p>';
          $('#btn-reprogramar').style.display = 'none';
          $('#btn-cancelar').style.display = 'none';
          if (btnAgendar) { btnAgendar.style.display = 'inline-flex'; }
        }
        
        // Renderizar historial de citas
        const historialTbody = $('#historial-citas-tbody');
        historialTbody.innerHTML = '';
        historial.forEach(cita => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${prettyDate(cita.fecha)}</td>
            <td>${cita.motivo}</td>
            <td><span class="chip status-${cita.estado.toLowerCase()}">${cita.estado}</span></td>
            <td>${cita.pago}</td>
          `;
          historialTbody.appendChild(row);
        });

        // Actualizar foto de perfil
        const foto = getProfilePhoto();
        if ($('#perfil-img')) {
          $('#perfil-img').src = foto;
        }
        if ($('#perfil-img-modal')) {
          $('#perfil-img-modal').src = foto;
        }
      }

      // ===== Elementos y Lógica de Eventos =====
      const modalAgendar = $('#modal-agendar');
      const modalReprogramar = $('#modal-reprogramar');
      const modalCancelar = $('#modal-cancelar');
      const modalPerfil = $('#modal-perfil');
      const modalCambiarPassword = $('#modal-cambiar-password');
      const modalCustomAlert = $('#modal-custom-alert');

      // Funciones de utilidad para modales
      function openModal(modal) { modal.classList.add('is-visible'); }
      function closeModal(modal) { modal.classList.remove('is-visible'); }
      function showCustomAlert(title, message) {
        if (!modalCustomAlert) return;
        $('#custom-alert-title').textContent = title;
        $('#custom-alert-message').textContent = message;
        openModal(modalCustomAlert);
      }
      
      // Manejadores de eventos de botones
      if ($('#btn-agendar')) {
          $('#btn-agendar').addEventListener('click', () => {
              const agendarFechaInput = $("#agendar-fecha");
              if (agendarFechaInput) { agendarFechaInput.min = isoToday; }
              openModal(modalAgendar);
          });
      }
      
      if ($('#btn-reprogramar')) {
          $('#btn-reprogramar').addEventListener('click', () => {
              if (getReprogCount() >= 1) {
                  showCustomAlert('Límite de Reprogramación', 'Ya has reprogramado tu cita una vez. Para volver a hacerlo, por favor contacta a tu dentista.');
              } else {
                  const reprogramarFechaInput = $("#reprogramar-fecha");
                  if (reprogramarFechaInput) { reprogramarFechaInput.min = isoToday; }
                  openModal(modalReprogramar);
              }
          });
      }
      
      if ($('#btn-cancelar')) {
          $('#btn-cancelar').addEventListener('click', () => openModal(modalCancelar));
      }
      
      if ($('#btn-editar-perfil')) {
          $('#btn-editar-perfil').addEventListener('click', () => {
              // Inicializar modal de perfil con los datos actuales
              if ($('#perfil-nombre')) $('#perfil-nombre').value = initialState.perfil.nombre;
              if ($('#perfil-email')) $('#perfil-email').value = initialState.perfil.email;
              if ($('#perfil-tel')) $('#perfil-tel').value = initialState.perfil.telefono;
              if ($('#perfil-direccion')) $('#perfil-direccion').value = initialState.perfil.direccion;
              if ($('#perfil-id-modal')) $('#perfil-id-modal').textContent = initialState.perfil.id;
              openModal(modalPerfil);
          });
      }

      if ($('#btn-cambiar-password')) {
          $('#btn-cambiar-password').addEventListener('click', () => {
              const lastChange = getLastPwChange();
              const threeMonths = 90 * 24 * 60 * 60 * 1000;
              
              if (lastChange && (Date.now() - lastChange < threeMonths)) {
                  showCustomAlert('Límite de Tiempo', 'Solo puedes cambiar tu contraseña cada 3 meses por seguridad. Inténtalo de nuevo más tarde.');
              } else {
                  openModal(modalCambiarPassword);
              }
          });
      }

      // Cierre de modales
      $$('.modal-close').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal-overlay'))));
      $$('.modal-overlay').forEach(overlay => overlay.addEventListener('click', (e) => {
        if (e.target === overlay) closeModal(overlay);
      }));

      // Lógica de formularios
      if ($('#form-agendar')) {
        $('#form-agendar').addEventListener('submit', (e) => {
          e.preventDefault();
          const fecha = $('#agendar-fecha').value;
          const hora = $('#agendar-hora').value;
          const motivo = $('#agendar-motivo').value;
          
          if (!/^\d{4}-\d{2}-\d{2}$/.test(fecha)) {
              showCustomAlert("Formato de fecha inválido", "Por favor, selecciona una fecha válida.");
              return;
          }

          if (new Date(fecha) < new Date(isoToday)) {
              showCustomAlert("Error de fecha", "No puedes agendar citas en fechas pasadas.");
              return;
          }

          if (festiveDates.includes(fecha)) {
              showCustomAlert("Día no disponible", "No se puede agendar una cita en un día festivo. Por favor, elige otra fecha.");
              return;
          }

          setProx({
            fecha: fecha,
            hora: hora,
            motivo: motivo,
            consultorio: 'Dr. Castellón - Sala 2',
            estado: 'Agendada',
            precio: 'Ficticio'
          });
          setReprogCount(0);
          showCustomAlert('Cita Agendada', 'Tu cita ha sido agendada con éxito.');
          closeModal(modalAgendar);
          render();
        });
      }
      
      if ($('#form-reprogramar')) {
        $('#form-reprogramar').addEventListener('submit', (e) => {
          e.preventDefault();
          const proxCita = getProx();
          const nuevaFecha = $('#reprogramar-fecha').value;
          const nuevaHora = $('#reprogramar-hora').value;

          if (!/^\d{4}-\d{2}-\d{2}$/.test(nuevaFecha)) {
              showCustomAlert("Formato de fecha inválido", "Por favor, selecciona una fecha válida.");
              return;
          }

          if (new Date(nuevaFecha) < new Date(isoToday)) {
              showCustomAlert("Error de fecha", "No puedes reprogramar para una fecha pasada.");
              return;
          }

          proxCita.fecha = nuevaFecha;
          proxCita.hora = nuevaHora;
          proxCita.estado = 'Reprogramada';
          setProx(proxCita);
          setReprogCount(getReprogCount() + 1);
          showCustomAlert('Cita Reprogramada', 'Tu cita ha sido reprogramada con éxito. Ya no podrás volver a hacerlo.');
          closeModal(modalReprogramar);
          render();
        });
      }

      if ($('#confirmar-cancelar')) {
        $('#confirmar-cancelar').addEventListener('click', () => {
          const proxCita = getProx();
          const historial = getHistorial();
          
          if (proxCita) {
            historial.unshift({
              fecha: proxCita.fecha,
              motivo: proxCita.motivo,
              estado: 'Cancelada',
              pago: '-'
            });
            setHistorial(historial);
            setProx(null);
            showCustomAlert('Cita Cancelada', 'Tu cita ha sido cancelada con éxito.');
            closeModal(modalCancelar);
            render();
          }
        });
      }
      
      if ($('#form-perfil')) {
        $('#form-perfil').addEventListener('submit', (e) => {
          e.preventDefault();
          showCustomAlert('Perfil Actualizado', 'Tus datos han sido guardados.');
          closeModal(modalPerfil);
        });
      }

      if ($('#form-cambiar-password')) {
        $('#form-cambiar-password').addEventListener('submit', (e) => {
          e.preventDefault();
          setLastPwChange(Date.now());
          showCustomAlert('Contraseña Cambiada', 'Tu contraseña se ha cambiado con éxito. Podrás cambiarla de nuevo en 3 meses.');
          closeModal(modalCambiarPassword);
        });
      }
      
      // Manejar la carga de la foto de perfil y el botón de eliminar
      if ($('#perfil-foto-input-main')) {
        $('#perfil-foto-input-main').addEventListener('change', function(event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
              const dataUrl = e.target.result;
              if ($('#perfil-img')) $('#perfil-img').src = dataUrl;
              setProfilePhoto(dataUrl);
            };
            reader.readAsDataURL(file);
          }
        });
      }

      if ($('#perfil-foto-input-modal')) {
        $('#perfil-foto-input-modal').addEventListener('change', function(event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
              const dataUrl = e.target.result;
              if ($('#perfil-img-modal')) $('#perfil-img-modal').src = dataUrl;
              if ($('#perfil-img')) $('#perfil-img').src = dataUrl;
              setProfilePhoto(dataUrl);
            };
            reader.readAsDataURL(file);
          }
        });
      }
      
      if ($('#btn-eliminar-foto')) {
        $('#btn-eliminar-foto').addEventListener('click', function() {
          const placeholderImg = 'https://placehold.co/80x80/007bff/ffffff?text=AP';
          if ($('#perfil-img-modal')) $('#perfil-img-modal').src = placeholderImg;
          if ($('#perfil-img')) $('#perfil-img').src = placeholderImg;
          setProfilePhoto(placeholderImg);
        });
      }

      // Lógica para el modo claro/oscuro
      const themeToggle = $('#theme-toggle');

      function applyTheme(theme) {
        if (theme === 'dark') {
          document.body.classList.add('dark-mode');
          if (themeToggle) themeToggle.checked = true;
        } else {
          document.body.classList.remove('dark-mode');
          if (themeToggle) themeToggle.checked = false;
        }
      }

      if (themeToggle) {
          themeToggle.addEventListener('change', (e) => {
            const newTheme = e.target.checked ? 'dark' : 'light';
            setTheme(newTheme);
            applyTheme(newTheme);
          });
      }

      // Inicializar el tema y la foto de perfil al cargar la página
      applyTheme(getTheme());
      const savedPhoto = getProfilePhoto();
      if (savedPhoto) {
        if ($('#perfil-img')) $('#perfil-img').src = savedPhoto;
      }
      
      // Renderizar al iniciar
      render();
    })();
  </script>
{% endblock %}