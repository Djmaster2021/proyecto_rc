{% extends "paciente/base.html" %}
{% block ptitle %}Pagos{% endblock %}
{% block pcontent %}
  <h3>Pagos</h3>
  <p>Resumen de pagos y recibos próximamente…</p>

  <!-- ===== IA (frontend puro) ===== -->
  <button id="aiFab" class="ai-fab" aria-label="Abrir asistente IA">IA</button>
  <aside id="aiDock" class="ai-dock" aria-hidden="true">
    <header class="ai-head">
      <strong>Asistente IA</strong>
      <button id="aiClose" class="ai-icon" aria-label="Cerrar">✕</button>
    </header>
    <div id="aiBody" class="ai-body" role="log" aria-live="polite">
      <div class="ai-tip">💳 Te ayudo con tus pagos.</div>
      <div class="ai-suggests">
        <button class="ai-chip" data-q="¿Cómo veo mis citas?">Ir a citas</button>
        <button class="ai-chip" data-q="¿Qué puedo hacer aquí?">¿Qué hay aquí?</button>
      </div>
    </div>
    <form id="aiForm" class="ai-form" autocomplete="off">
      <input id="aiInput" class="ai-input" placeholder="Escribe tu consulta… (Enter para enviar)" />
      <button class="ai-send" aria-label="Enviar">➤</button>
    </form>
  </aside>

  <style>
    .ai-fab{position:fixed;right:18px;bottom:18px;border:1px solid rgba(127,127,127,.35);background:transparent;color:inherit;border-radius:999px;padding:.7rem 1rem;font-weight:700;box-shadow:0 8px 24px rgba(0,0,0,.15);z-index:60}
    .ai-dock{position:fixed;right:18px;bottom:18px;top:18px;width:min(420px,92vw);background:transparent;border:1px solid rgba(127,127,127,.25);border-radius:1rem;display:flex;flex-direction:column;transform:translateY(calc(100% + 18px));transition:transform .25s ease;z-index:61;backdrop-filter:blur(6px)}
    .ai-dock[aria-hidden="false"]{transform:translateY(0)}
    .ai-head{display:flex;align-items:center;justify-content:space-between;padding:.8rem 1rem;border-bottom:1px solid rgba(127,127,127,.25)}
    .ai-icon{border:1px solid rgba(127,127,127,.25);background:transparent;border-radius:.6rem;padding:.35rem .55rem}
    .ai-body{padding:1rem;display:flex;flex-direction:column;gap:.6rem;overflow:auto;max-height:65vh}
    .ai-suggests{display:flex;flex-wrap:wrap;gap:.4rem}
    .ai-chip{border:1px solid rgba(127,127,127,.35);background:transparent;border-radius:999px;padding:.35rem .6rem;font-size:.85rem}
    .ai-msg{border:1px solid rgba(127,127,127,.25);border-radius:.7rem;padding:.55rem .7rem;white-space:pre-wrap}
    .ai-msg.user{background:rgba(59,130,246,.08);border-color:rgba(59,130,246,.35)}
    .ai-msg.bot{background:rgba(34,197,94,.08);border-color:rgba(34,197,94,.35)}
    .ai-form{display:flex;gap:.5rem;padding:.8rem 1rem;border-top:1px solid rgba(127,127,127,.25)}
    .ai-input{flex:1;border:1px solid rgba(127,127,127,.35);border-radius:.6rem;background:transparent;color:inherit;padding:.5rem .6rem}
    .ai-send{border:1px solid rgba(127,127,127,.35);background:transparent;border-radius:.6rem;padding:.5rem .7rem}
    @media (max-width:720px){.ai-dock{top:auto;height:72vh}}
  </style>

  <script>
    (function(){
      const $=s=>document.querySelector(s);
      const fab=$('#aiFab'), dock=$('#aiDock'), close=$('#aiClose'), body=$('#aiBody'), form=$('#aiForm'), input=$('#aiInput');
      const urlCitas = document.querySelector('a[href*="citas"]')?.href || "{% url 'paciente:citas' %}";

      function open(){dock.setAttribute('aria-hidden','false'); input?.focus();}
      function closeDock(){dock.setAttribute('aria-hidden','true');}
      function msg(role,txt){const d=document.createElement('div'); d.className='ai-msg '+(role==='user'?'user':'bot'); d.textContent=txt; body.appendChild(d); body.scrollTop=body.scrollHeight;}

      function answer(q){
        const t=(q||'').toLowerCase();
        if(t.includes('cita')){ window.location.href=urlCitas; return 'Abriendo “Citas”…'; }
        if(t.includes('qué puedo')||t.includes('que puedo')||t.includes('aquí')){
          return 'Aquí verás tus pagos/recibos (en esta maqueta aún no hay tabla). Puedo llevarte a “Citas”.';
        }
        return 'Puedo llevarte a “Citas” o contarte qué puedes hacer aquí.';
      }

      fab?.addEventListener('click', open);
      close?.addEventListener('click', closeDock);
      window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeDock(); });
      body?.addEventListener('click', e=>{const b=e.target.closest('.ai-chip'); if(!b) return; input.value=b.dataset.q||''; input.focus();});
      form?.addEventListener('submit', e=>{
        e.preventDefault();
        const q=input.value.trim(); if(!q) return;
        msg('user',q); input.value='';
        msg('bot',answer(q));
      });
    })();
  </script>
{% endblock %}
