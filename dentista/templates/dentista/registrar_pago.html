{% extends "dentista/base.html" %}
{% load static %}

{% block dtitle %}Nuevo ingreso | RC{% endblock %}

{% block dcontent %}
<div class="main-container">
    <div class="page-header compact" style="margin-bottom: 1.5rem;">
        <div>
            <h1 class="text-gradient">Registrar ingreso</h1>
            <p class="subtitle">Cobro manual. Se crea un comprobante ligado a “Pago Directo”.</p>
        </div>
        <a href="{% url 'dentista:pagos' %}" class="cyber-btn">Volver a caja</a>
    </div>

    <div class="cyber-card" style="max-width: 720px; margin: 0 auto;">
        <form method="post" style="display:flex; flex-direction:column; gap:18px;">
            {% csrf_token %}

            <div>
                <label class="form-label"><i class="ph-bold ph-calendar-check"></i> Cita pendiente (opcional)</label>
                <select name="cita_id" id="citaSelect" class="form-control">
                    <option value="">Pago directo (sin cita)</option>
                    {% for c in citas %}
                        <option value="{{ c.id }}" data-monto="{{ c.servicio.precio }}" data-concepto="{{ c.servicio.nombre }} - {{ c.paciente.nombre }}" {% if c.id|stringformat:"s" == cita_preseleccionada %}selected{% endif %}>
                            {{ c.paciente.nombre }} · {{ c.servicio.nombre }} · {{ c.fecha }} {{ c.hora_inicio|time:"H:i" }} · ${{ c.servicio.precio }}
                        </option>
                    {% endfor %}
                </select>
                <p style="font-size:0.8rem; color:#94a3b8; margin-top:6px;">Si eliges una cita, se llena monto y concepto automáticamente.</p>
            </div>

            <div>
                <label class="form-label"><i class="ph-bold ph-currency-dollar"></i> Monto</label>
                <input type="number" name="monto" id="montoInput" step="0.01" class="form-control" required placeholder="0.00">
            </div>

            <div>
                <label class="form-label"><i class="ph-bold ph-note"></i> Concepto / nota</label>
                <input type="text" name="concepto" id="conceptoInput" class="form-control" required placeholder="Ej. Pago en mostrador - Juan Perez, Limpieza">
            </div>

            <div>
                <label class="form-label"><i class="ph-bold ph-credit-card"></i> Método</label>
                <select name="metodo" class="form-control">
                    <option value="EFECTIVO">Efectivo</option>
                    <option value="TRANSFERENCIA">Transferencia</option>
                    <option value="TARJETA">Tarjeta</option>
                    <option value="MERCADOPAGO">MercadoPago (link de pago)</option>
                </select>
            </div>

            <p style="font-size:0.85rem; color:#64748b; margin-top:-4px;">
                * Si no eliges cita, se usa el paciente genérico “Venta Mostrador / Rápida” y servicio “Pago Directo”.
            </p>

            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px;">
                <a href="{% url 'dentista:pagos' %}" class="cyber-btn cyber-btn-secondary">Cancelar</a>
                <button type="submit" class="cyber-btn cyber-btn-glow">Guardar cobro</button>
            </div>
        </form>
    </div>
</div>
<script>
    const citaSelect = document.getElementById('citaSelect');
    const montoInput = document.getElementById('montoInput');
    const conceptoInput = document.getElementById('conceptoInput');
    const preselected = "{{ cita_preseleccionada|default:'' }}";

    citaSelect.addEventListener('change', () => {
        const opt = citaSelect.options[citaSelect.selectedIndex];
        const monto = opt.getAttribute('data-monto');
        const concepto = opt.getAttribute('data-concepto');
        if (monto) montoInput.value = monto;
        if (concepto) conceptoInput.value = concepto;
        if (!opt.value) {
            montoInput.value = "";
            conceptoInput.value = "";
        }
    });

    if (preselected) {
        citaSelect.value = preselected;
        citaSelect.dispatchEvent(new Event('change'));
    }
</script>
{% endblock %}
