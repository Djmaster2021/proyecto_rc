{% extends "dentista/base.html" %}
{% load static %}

{% block dtitle %}Agenda Clínica | RC{% endblock %}

{% block extra_css %}
<style>
/* Layout shell */
.agenda-shell {
    padding: 18px 10px 48px;
    background: radial-gradient(circle at 10% 20%, #e9f7ff 0%, #f6fbff 30%, #f5f7f8 70%);
    position: relative;
}
.agenda-shell::before {
    content: "";
    position: absolute;
    inset: 12px 24px 40px;
    background: linear-gradient(135deg, rgba(15, 148, 116, 0.04), rgba(15, 183, 160, 0.06));
    filter: blur(38px);
    border-radius: 28px;
    z-index: 0;
    pointer-events: none;
}
.agenda-shell > * { position: relative; z-index: 1; }

.agenda-head {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 16px;
    margin-bottom: 18px;
}
.agenda-head h1 {
    margin: 0 0 6px;
    font-weight: 800;
    color: #0c2c3b;
}
.agenda-eyebrow {
    letter-spacing: .08em;
    font-size: 12px;
    text-transform: uppercase;
    color: #7ea0b3;
    font-weight: 800;
}
.agenda-head p {
    margin: 0;
    color: #4e5f6d;
}
.agenda-head-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}
.pill-switch {
    background: #d8e6ec;
    border-radius: 16px;
    padding: 4px;
    display: inline-flex;
    gap: 4px;
}
.pill-switch a {
    font-size: 13px;
    padding: 8px 12px;
    border-radius: 12px;
    color: #2c3f4b;
    text-decoration: none;
    font-weight: 700;
}
.pill-switch a.active {
    background: linear-gradient(135deg, #0f9474, #0fb7a0);
    color: #fff;
    box-shadow: 0 6px 18px rgba(15, 148, 116, 0.3);
}
.cta-btn {
    background: linear-gradient(135deg, #0f9474, #0fb7a0);
    color: #fff;
    border: none;
    border-radius: 12px;
    padding: 10px 16px;
    font-weight: 800;
    display: inline-flex;
    gap: 8px;
    align-items: center;
    text-decoration: none;
    box-shadow: 0 8px 20px rgba(15, 148, 116, 0.25);
}

/* Grid */
.agenda-grid-shell {
    display: grid;
    grid-template-columns: 340px 1fr;
    gap: 16px;
    align-items: start;
}
@media (max-width: 1100px) {
    .agenda-grid-shell { grid-template-columns: 1fr; }
}

.side-stack {
    display: grid;
    gap: 12px;
}
.card-slab {
    background: radial-gradient(circle at 20% 15%, rgba(15, 183, 160, 0.12), transparent 45%), #fff;
    border-radius: 16px;
    padding: 16px;
    box-shadow: 0 12px 32px rgba(31, 41, 51, 0.08);
    border: 1px solid #e3ebf0;
}
.card-slab h4 {
    margin: 0 0 6px;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: .08em;
    color: #7a8e9c;
    font-weight: 800;
}
.card-slab .muted { color: #5d6a75; font-size: 13px; margin: 4px 0 0; }
.status-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 999px;
    background: #ffe9e7;
    color: #b5433f;
    font-weight: 800;
    font-size: 12px;
}
.status-chip.green { background: #e7fff6; color: #0f9474; }
.big-number {
    font-size: 32px;
    font-weight: 900;
    color: #0c2c3b;
}
.month-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
}
.today-chip {
    background: linear-gradient(135deg, #0f9474, #0fb7a0);
    color: #fff;
    padding: 10px 14px;
    border-radius: 12px;
    font-weight: 800;
    text-align: center;
    min-width: 70px;
}
.legend-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 8px;
}
.legend-row {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #4b5c69;
    font-weight: 700;
}
.dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
}
.dot.green { background: #0f9474; }
.dot.amber { background: #f59e0b; }
.dot.blue { background: #059669; }
.dot.red { background: #ef4444; }

/* Agenda board */
.agenda-board {
    background: #fff;
    border-radius: 16px;
    padding: 14px;
    border: 1px solid #e5ebf0;
    box-shadow: 0 16px 40px rgba(31, 41, 51, 0.08);
}
.days-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 12px;
}
.day-card {
    background: linear-gradient(180deg, #f8fbfc 0%, #ffffff 100%);
    border: 1px solid #e2e8ed;
    border-radius: 14px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    min-height: 210px;
    position: relative;
    overflow: hidden;
}
.day-card::after {
    content: "";
    position: absolute;
    inset: -20px;
    background: radial-gradient(circle at 10% 10%, rgba(15, 183, 160, 0.08), transparent 35%);
    pointer-events: none;
}
.day-card > * { position: relative; z-index: 1; }
.day-card.today { box-shadow: 0 0 0 2px #0f9474 inset, 0 12px 24px rgba(15, 148, 116, 0.15); }
.day-card.off { background: #fbfcfd; opacity: 0.9; }
.day-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 6px;
}
.day-label {
    display: flex;
    flex-direction: column;
    gap: 2px;
}
.day-label .weekday {
    font-size: 12px;
    letter-spacing: .05em;
    color: #7c90a0;
    text-transform: uppercase;
}
.day-label .day-number {
    font-size: 22px;
    font-weight: 900;
    color: #0c2c3b;
}
.day-count {
    background: #e5f5f0;
    color: #0f9474;
    padding: 6px 10px;
    border-radius: 12px;
    font-weight: 800;
    font-size: 12px;
}
.citas-stack {
    display: grid;
    gap: 8px;
    max-height: 260px;
    overflow-y: auto;
    padding-right: 6px;
}
.cita-card {
    border: 1px solid #e0e7ec;
    border-radius: 12px;
    padding: 10px;
    background: #fff;
    box-shadow: 0 6px 14px rgba(31, 41, 51, 0.04);
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 10px;
    align-items: center;
}
.cita-card .avatar {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    background: linear-gradient(135deg, #0f9474, #0fb7a0);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    cursor: pointer;
    text-decoration: none;
}
.cita-card .time {
    font-weight: 800;
    color: #0f9474;
    font-size: 13px;
    display: inline-flex;
    gap: 6px;
    align-items: center;
}
.cita-card .patient {
    margin: 0;
    font-weight: 800;
    color: #0c2c3b;
}
.cita-card .service {
    margin: 0;
    font-size: 12px;
    color: #5f6c75;
}
.card-actions {
    display: grid;
    gap: 6px;
    justify-items: end;
}
.card-actions a,
.card-actions button {
    background: #eef3f6;
    border: none;
    color: #415362;
    padding: 6px;
    border-radius: 10px;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease, color 0.2s ease;
}
.card-actions a:hover,
.card-actions button:hover {
    background: #0f9474;
    color: #fff;
}
.empty-day {
    padding: 14px;
    border: 1px dashed #d1d9df;
    border-radius: 12px;
    text-align: center;
    color: #7c8c99;
    font-weight: 700;
}
.add-link {
    margin-top: auto;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: #0f9474;
    font-weight: 800;
    font-size: 13px;
    text-decoration: none;
}
</style>
{% endblock %}

{% block dcontent %}
<div class="agenda-shell">
    <div class="agenda-head">
        <div>
            <div class="agenda-eyebrow">Agenda Clínica</div>
            <h1>Agenda Clínica</h1>
            <p>Vista operativa de alta densidad.</p>
        </div>
        <div class="agenda-head-actions">
            <div class="pill-switch">
                <a href="{% url 'dentista:agenda_modo' 'dia' %}" class="{% if modo == 'dia' %}active{% endif %}">Hoy</a>
                <a href="{% url 'dentista:agenda_modo' 'semana' %}" class="{% if modo == 'semana' %}active{% endif %}">Semana</a>
                <a href="{% url 'dentista:agenda_modo' 'mes' %}" class="{% if modo == 'mes' %}active{% endif %}">Mes</a>
                <a href="{% url 'dentista:agenda' %}" class="{% if modo == 'todo' %}active{% endif %}">Todo</a>
            </div>
            <a class="cta-btn" href="{% url 'dentista:crear_cita_manual' %}"><i class="ph-bold ph-plus"></i> Nueva Cita</a>
        </div>
    </div>

    <div class="agenda-grid-shell">
        <div class="side-stack">
            <div class="card-slab">
                <h4>En curso / siguiente</h4>
                <div class="status-chip {% if resumen_agenda.estado == 'libre' %}{% else %}green{% endif %}">
                    {% if resumen_agenda.estado == 'libre' %}Libre{% else %}{{ resumen_agenda.label }}{% endif %}
                </div>
                {% if resumen_agenda.paciente %}
                    <p class="muted">{{ resumen_agenda.paciente }} — {{ resumen_agenda.servicio }}</p>
                    <p class="muted" style="font-weight:700;">{{ resumen_agenda.horario }}</p>
                {% else %}
                    <p class="muted">Agenda libre por ahora.</p>
                {% endif %}
            </div>

            <div class="card-slab">
                <h4>Vistos hoy</h4>
                <div class="big-number">{{ resumen_hoy.finalizadas|default:0 }}</div>
                <p class="muted">de {{ resumen_hoy.total|default:"0" }} pacientes.</p>
            </div>

            <div class="card-slab month-card">
                <div>
                    <h4>{{ fecha_actual|date:"F Y"|upper }}</h4>
                    <span class="muted">Reloj {{ fecha_actual|date:"l" }}</span>
                </div>
                <div class="today-chip">
                    {{ fecha_actual|date:"d" }}<br><small style="font-weight:700;">{% now "H:i" %}</small>
                </div>
            </div>

            <div class="card-slab">
                <h4>Estados</h4>
                <ul class="legend-list">
                    <li class="legend-row"><span class="dot green"></span> Confirmada <strong>{{ estado_counts.confirmada|default:0 }}</strong></li>
                    <li class="legend-row"><span class="dot amber"></span> Pendiente <strong>{{ estado_counts.pendiente|default:0 }}</strong></li>
                    <li class="legend-row"><span class="dot blue"></span> Finalizada <strong>{{ estado_counts.completada|default:0 }}</strong></li>
                    <li class="legend-row"><span class="dot red"></span> Cancelada <strong>{{ estado_counts.cancelada|default:0 }}</strong></li>
                </ul>
            </div>
        </div>

        <div class="agenda-board">
            <div class="days-grid">
                {% for semana in semanas %}
                    {% for dia in semana %}
                        <div class="day-card {% if dia.fecha == fecha_actual %}today{% endif %} {% if dia.tipo_dia != 'laboral' %}off{% endif %}">
                            <div class="day-header">
                                <div class="day-label">
                                    <span class="weekday">{{ dia.fecha|date:"l"|upper }}</span>
                                    <span class="day-number">{{ dia.fecha|date:"d" }}</span>
                                </div>
                                <span class="day-count">{{ dia.citas|length }} citas</span>
                            </div>

                            <div class="citas-stack">
                                {% if dia.tipo_dia != 'laboral' and not dia.citas %}
                                    <div class="empty-day">Descanso</div>
                                {% elif dia.citas %}
                                    {% for item in dia.citas %}
                                        {% with c=item.obj %}
                                            <div class="cita-card">
                                                <a class="avatar" href="{% url 'dentista:consulta' c.id %}" title="Abrir expediente">
                                                    {{ c.paciente.nombre|slice:":1"|upper }}
                                                </a>
                                                <div>
                                                    <div class="time"><i class="ph-bold ph-clock"></i>{{ c.hora_inicio|time:"H:i" }}</div>
                                                    <p class="patient">{{ c.paciente.nombre }}</p>
                                                    <p class="service">{{ c.servicio.nombre|truncatechars:40 }}</p>
                                                </div>
                                                <div class="card-actions">
                                                    <a href="{% url 'dentista:consulta' c.id %}" title="Ver expediente">
                                                        <i class="ph-bold ph-file-text"></i>
                                                    </a>
                                                    <a href="{% url 'dentista:crear_cita_manual' %}?paciente={{ c.paciente.id }}&fecha={{ c.fecha|date:'Y-m-d' }}" title="Modificar">
                                                        <i class="ph-bold ph-pencil-simple"></i>
                                                    </a>
                                                    <form method="post" action="{% url 'dentista:eliminar_cita' c.id %}" class="js-delete-form" style="margin:0;">
                                                        {% csrf_token %}
                                                        <button type="button" data-nombre="{{ c.paciente.nombre }}" title="Eliminar">
                                                            <i class="ph-bold ph-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        {% endwith %}
                                    {% endfor %}
                                {% else %}
                                    <div class="empty-day">Sin citas</div>
                                {% endif %}
                            </div>

                            {% if dia.tipo_dia == 'laboral' %}
                                <a class="add-link" href="{% url 'dentista:crear_cita_manual' %}?fecha={{ dia.fecha|date:'Y-m-d' }}"><i class="ph-bold ph-plus-circle"></i> Agendar</a>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const deleteButtons = document.querySelectorAll('.js-delete-form button');
    deleteButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const form = this.closest('form');
            const nombre = this.dataset.nombre || 'la cita';
            Swal.fire({
                title: '¿Eliminar cita?',
                text: `Se eliminará la cita de ${nombre}`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#334155',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    form.submit();
                }
            });
        });
    });
});
</script>
{% endblock %}
