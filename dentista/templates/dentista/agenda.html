{% extends "dentista/base.html" %}
{% load static %}

{% block dtitle %}Agenda General | RC{% endblock %}

{% block dcontent %}

<div class="page-header" style="margin-bottom: 1.5rem;">
    <div>
        <h1 class="text-gradient">Agenda Clínica</h1>
        <p class="welcome-subtitle">Vista general de operaciones.</p>
    </div>
    
    <div style="display: flex; gap: 1rem; align-items: center;">
        <a href="{% url 'dentista:crear_cita_manual' %}" class="cyber-btn cyber-btn-glow">
            <i class="ph-bold ph-plus"></i> Nueva Cita
        </a>
    </div>
</div>

<div class="agenda-layout">

    <aside class="agenda-sidebar">
        <div class="hero-patient-card" style="margin-bottom: 1.5rem; border-color: var(--brand);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-subtle); padding-bottom: 10px;">
                <span style="font-size: 0.7rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase;">Estado</span>
                <span class="status-badge status-active">● Activo</span>
            </div>

            <div class="hp-empty" style="padding: 1rem 0; text-align: center;">
                <i class="ph-duotone ph-calendar" style="font-size:2rem; margin-bottom:10px; color:var(--brand);"></i>
                <p style="color: var(--text-muted); font-size: 0.8rem; margin: 0;">Visualizando agenda completa.</p>
             </div>
        </div>

        <div class="cyber-card mini-cal-card" style="text-align: center; padding: 1.5rem; margin-bottom: 1.5rem;">
            <div style="margin-bottom: 0.5rem; font-weight: 800; font-size: 1.1rem; color: var(--text-main);">
                {{ fecha_actual|date:"F Y"|upper }}
            </div>
            <div class="today-circle" style="
                width: 60px; height: 60px; border-radius: 50%; 
                background: var(--bg-sidebar); color: #fff; 
                display: flex; flex-direction: column; align-items: center; justify-content: center; 
                margin: 0 auto 0.8rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <span style="font-size: 1.5rem; font-weight: 800; line-height: 1;">{{ fecha_actual|date:"d" }}</span>
            </div>
            <div style="font-size: 0.8rem; color: var(--text-muted); display:flex; justify-content:center; gap:5px;">
                <i class="ph-bold ph-clock"></i> <span>{% now "H:i" %}</span>
            </div>
        </div>
    </aside>

    <div class="agenda-main-view">
        <div class="agenda-kanban-grid" id="agendaGrid">
            {% for semana in semanas %}
                {% for dia in semana %}
                
                <div class="day-column day-card {% if dia.fecha == fecha_actual %}is-today{% endif %} day-item">
                    
                    <div class="day-header-sticky">
                        <div style="display: flex; flex-direction: column;">
                            <span style="font-size: 0.7rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase;">{{ dia.fecha|date:"l" }}</span>
                            <span style="font-size: 1.2rem; font-weight: 800; color: var(--text-main); line-height: 1;">{{ dia.fecha|date:"d" }}</span>
                        </div>
                        
                        {% if dia.tipo_dia == 'laboral' %}
                            <a href="{% url 'dentista:crear_cita_manual' %}?fecha={{ dia.fecha|date:'Y-m-d' }}" style="color: var(--brand); font-size: 1.2rem;">
                                <i class="ph-bold ph-plus-circle"></i>
                            </a>
                        {% endif %}
                    </div>

                    <div class="day-scroll-area">
                        {% if dia.citas %}
                            {% for item in dia.citas %}
                                {% with c=item.obj %}
                                
                                {% if "ghost-mode" in item.clase_extra %}
                                    
                                    <div class="appt-ticket ghost-mode js-ghost-click"
                                         data-paciente="{{ c.paciente.nombre }}"
                                         data-servicio="{{ c.servicio.nombre }}"
                                         data-inicio="{{ c.hora_inicio|time:'H:i' }}"
                                         data-fin="{{ c.hora_fin|time:'H:i' }}"
                                         data-url="{% url 'dentista:vista_consulta' c.id %}">
                                        
                                        <div class="ticket-header" style="justify-content: flex-start; gap: 5px;">
                                            <span><i class="ph-bold ph-clock"></i> {{ c.hora_inicio|time:"H:i" }}</span>
                                        </div>
                                        <div class="ticket-patient" style="opacity: 0.7;">{{ c.paciente.nombre }}</div>
                                        <div class="ticket-service" style="font-size: 0.75rem; color: #64748b;">
                                            <i class="ph-fill ph-check-circle"></i> Finalizada
                                        </div>
                                    </div>

                                {% else %}

                                    <div class="appt-ticket {{ c.estado|lower }} {% if not item.es_mia %}ticket-ajeno{% endif %}">
                                        
                                        <div class="ticket-header">
                                            <span><i class="ph-bold ph-clock"></i> {{ c.hora_inicio|time:"H:i" }}</span>
                                            
                                            {% if item.es_mia %}
                                                <div class="ticket-actions-hover">
                                                    <a href="{% url 'dentista:crear_cita_manual' %}?paciente={{ c.paciente.id }}" 
                                                       title="Editar" style="color: var(--text-muted);">
                                                       <i class="ph-bold ph-pencil-simple"></i>
                                                    </a>
                                                    
                                                    <form method="post" action="{% url 'dentista:eliminar_cita' c.id %}" class="js-delete-form" style="display:inline; margin:0;">
                                                        {% csrf_token %}
                                                        <button type="button" class="btn-delete-trigger" data-nombre="{{ c.paciente.nombre }}"
                                                                style="border:none; background:none; padding:0; color: var(--danger); cursor:pointer;">
                                                            <i class="ph-bold ph-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            {% else %}
                                                <span class="doctor-tag">{{ item.dentista_nombre }}</span>
                                            {% endif %}
                                        </div>
                                        
                                        <a href="{% url 'dentista:vista_consulta' c.id %}" style="text-decoration: none; display: block; margin-top: 4px;">
                                            <div class="ticket-patient">{{ c.paciente.nombre }}</div>
                                            <div class="ticket-service">{{ c.servicio.nombre|truncatechars:20 }}</div>
                                        </a>
                                    </div>

                                {% endif %} 
                                {% endwith %}
                            {% endfor %}

                        {% else %}
                            {% if dia.tipo_dia != 'laboral' %}
                                <div style="text-align: center; padding-top: 2rem; color: var(--text-muted); font-size: 0.8rem;">
                                    <i class="ph-fill ph-coffee" style="font-size: 1.5rem; display: block; margin-bottom: 5px; opacity: 0.4;"></i>
                                    {{ dia.festivo_label|default:"Descanso" }}
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% endfor %}
        </div>
    </div>
</div>

<div id="modal-cita-finalizada" class="modal-overlay" style="display: none;">
    <div class="modal-content cyber-card">
        <div class="modal-header">
            <h3 style="color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                <i class="ph-fill ph-check-circle" style="color: #00C9A7;"></i>
                Cita Finalizada
            </h3>
            <button id="btn-cerrar-modal" class="close-btn">&times;</button>
        </div>
        
        <div class="modal-body" style="text-align: center; padding: 20px;">
            <p style="font-size: 1.1rem; color: #555;">El tiempo de esta cita ha concluido.</p>
            
            <div class="patient-preview" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h2 id="modal-paciente" style="margin: 0; color: #333;">...</h2>
                <p id="modal-servicio" style="color: #0083B0; font-weight: 500; margin: 5px 0;">...</p>
                <small id="modal-horario" style="color: #888;">...</small>
            </div>

            <div class="modal-actions" style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <a id="btn-expediente" href="#" class="cyber-btn" style="background: #0083B0; color: white; text-decoration: none; padding: 10px 20px; border-radius: 6px;">
                    <i class="ph-bold ph-file-text"></i> Ver Expediente y Cobrar
                </a>
                <button id="btn-cancelar-modal" style="background: transparent; border: 1px solid #ccc; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // 1. MANEJO DE CLICKS EN CITAS FANTASMA (Usando Data Attributes)
        const ghostTickets = document.querySelectorAll('.js-ghost-click');
        const modal = document.getElementById('modal-cita-finalizada');
        
        // Elementos del modal
        const mPaciente = document.getElementById('modal-paciente');
        const mServicio = document.getElementById('modal-servicio');
        const mHorario = document.getElementById('modal-horario');
        const mBtnExpediente = document.getElementById('btn-expediente');

        ghostTickets.forEach(ticket => {
            ticket.addEventListener('click', function() {
                // Leer datos del HTML (Esto es lo limpio)
                const data = this.dataset;
                
                // Llenar modal
                mPaciente.textContent = data.paciente;
                mServicio.textContent = data.servicio;
                mHorario.textContent = `${data.inicio} - ${data.fin}`;
                mBtnExpediente.href = data.url;

                // Mostrar
                modal.style.display = 'flex';
            });
        });

        // 2. MANEJO DE CIERRE DE MODAL
        function cerrarModal() {
            modal.style.display = 'none';
        }
        
        document.getElementById('btn-cerrar-modal').addEventListener('click', cerrarModal);
        document.getElementById('btn-cancelar-modal').addEventListener('click', cerrarModal);
        
        window.onclick = function(event) {
            if (event.target == modal) {
                cerrarModal();
            }
        }

        // 3. MANEJO DE ELIMINACIÓN (SweetAlert)
        const deleteButtons = document.querySelectorAll('.btn-delete-trigger');
        deleteButtons.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation(); // Evitar click en la tarjeta padre
                const nombre = this.dataset.nombre;
                const form = this.closest('form');

                Swal.fire({
                    title: '¿Eliminar cita?',
                    text: `Se eliminará la cita de ${nombre}`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444',
                    cancelButtonColor: '#334155',
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        form.submit();
                    }
                });
            });
        });
    });
</script>

{% endblock %}