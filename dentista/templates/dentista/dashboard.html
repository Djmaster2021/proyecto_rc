{% extends "dentista/base.html" %}
{% load static %}

{% block dtitle %}Dashboard Dentista | RC Dental{% endblock %}

{% block extra_css %}
<style>
.agenda-grid {
    display: grid;
    gap: 10px;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
}
.agenda-card {
    border: 1px solid #d5e3eb;
    border-radius: 12px;
    background: #f8fbfc;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 6px;
}
.agenda-card.active {
    border-color: #1fb6ff;
    box-shadow: 0 0 0 2px rgba(31,182,255,0.15);
}
.agenda-card .day-label {
    font-weight: 800;
    color: #1b3c4d;
}
.agenda-card .date-num {
    font-size: 1.6rem;
    font-weight: 800;
    color: #0f1f2c;
    line-height: 1.1;
}
.agenda-item {
    background: #fff;
    border: 1px solid #e2eef3;
    border-radius: 10px;
    padding: 6px 8px;
    font-size: 0.92rem;
    display: flex;
    flex-direction: column;
    gap: 2px;
}
.agenda-item .time { font-weight: 800; color: #0f172a; }
.agenda-item .pac { font-weight: 700; color: #1b3c4d; }
.agenda-item .srv { color: #64748b; font-size: 0.85rem; }
.agenda-wrapper {
    border: 1px solid #d5e3eb;
    border-radius: 16px;
    background: #fff;
    padding: 16px;
}
.grid-layout {
    display: grid;
    gap: 16px;
    grid-template-columns: 2fr 1fr;
}
@media (max-width: 1024px) {
    .grid-layout { grid-template-columns: 1fr; }
}
</style>
{% endblock %}

{% block dcontent %}

<div class="page-header">
    <div class="welcome-text">
        <h1 class="text-gradient">Hola, Dr. {{ dentista.nombre }} ðŸ‘‹</h1>
        <p class="welcome-subtitle">
            <i class="ph-bold ph-calendar-blank"></i>
            {% now "l d F, Y" %} â€¢ Panel de Control
        </p>
    </div>
    <div class="header-actions">
        <a href="{% url 'dentista:crear_cita_manual' %}" class="cyber-btn cyber-btn-glow">
            <i class="ph-bold ph-plus"></i> Nueva Cita
        </a>
    </div>
</div>

<div class="kpi-row">
    <div class="kpi-card kpi-green">
        <div class="kpi-icon"><i class="ph-duotone ph-calendar-check"></i></div>
        <div class="kpi-content">
            <h3 class="kpi-value">{{ citas_hoy.count }}</h3>
            <span class="kpi-label">Citas Hoy</span>
        </div>
    </div>
    <div class="kpi-card kpi-orange">
        <div class="kpi-icon"><i class="ph-duotone ph-clock-countdown"></i></div>
        <div class="kpi-content">
            <h3 class="kpi-value">{{ kpi_pendientes }}</h3>
            <span class="kpi-label">Pendientes</span>
        </div>
    </div>
    <div class="kpi-card kpi-blue">
        <div class="kpi-icon"><i class="ph-duotone ph-users"></i></div>
        <div class="kpi-content">
            <h3 class="kpi-value">{{ kpi_pacientes }}</h3>
            <span class="kpi-label">Pacientes</span>
        </div>
    </div>
    <div class="kpi-card kpi-money">
        <div class="kpi-icon"><i class="ph-bold ph-currency-dollar"></i></div>
        <div class="kpi-content">
            <h3 class="kpi-value">${{ ingresos_mes|floatformat:2 }}</h3>
            <span class="kpi-label">Ingresos Mes</span>
        </div>
    </div>
</div>

<div class="grid-layout">

    <div class="agenda-wrapper">
        <div class="panel-header" style="margin-bottom: 12px;">
            <h3 style="margin:0;"><i class="ph-bold ph-calendar-check"></i> Agenda</h3>
            <a href="{% url 'dentista:agenda' %}" class="link-action">Ver Agenda</a>
        </div>
        <div class="agenda-grid">
            {% for dia in calendario_dias %}
            <div class="agenda-card {% if dia.dia == fecha_actual %}active{% endif %}">
                <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                    <div>
                        <div class="day-label">{{ dia.label_dia|upper }}</div>
                        <div class="date-num">{{ dia.dia|date:"d" }}</div>
                    </div>
                    {% if dia.dia == fecha_actual %}
                        <span class="badge badge-success">HOY</span>
                    {% endif %}
                </div>
                {% for c in dia.citas %}
                <div class="agenda-item">
                    <span class="time">{{ c.hora }}</span>
                    <span class="pac">{{ c.paciente }}</span>
                    <span class="srv">{{ c.servicio|default:"Cita" }}</span>
                </div>
                {% empty %}
                <small style="color:#94a3b8;">Sin citas</small>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="side-stack">

        <div class="hero-patient-card">
            {% if proxima_cita %}
                <div class="hp-status-bar"></div>
                <div class="hp-content">
                    <span class="hp-label">Siguiente Paciente</span>
                    <h2 class="hp-name">{{ proxima_cita.paciente.nombre }}</h2>
                    <p class="hp-service">{{ proxima_cita.servicio.nombre }}</p>
                    
                    <div class="hp-time-box">
                        <div class="time-big">{{ proxima_cita.hora_inicio|time:"H:i" }}</div>
                        <div class="duration-small">{{ proxima_cita.servicio.duracion_estimada }} min</div>
                    </div>

                    <a href="{% url 'dentista:consulta' proxima_cita.id %}" class="cyber-btn cyber-btn-full">
                        Abrir Expediente <i class="ph-bold ph-arrow-right"></i>
                    </a>
                </div>
            {% else %}
                <div class="hp-empty">
                    <i class="ph-duotone ph-coffee"></i>
                    <p>No hay mÃ¡s citas por hoy.</p>
                </div>
            {% endif %}
        </div>

        <div class="cyber-card payments-card">
            <h4 class="card-title"><i class="ph-bold ph-credit-card"></i> Recientes</h4>
            <div class="payments-list">
                {% for p in pagos|slice:":5" %}
                <div class="payment-item">
                    <div class="pay-icon-wrapper">
                        <i class="ph-bold ph-money"></i>
                    </div>
                    <div class="pay-details">
                        <span class="pay-method">{{ p.metodo }}</span>
                        <span class="pay-date">{{ p.created_at|date:"d M, H:i" }}</span>
                    </div>
                    <div class="pay-amount">
                        +${{ p.monto|floatformat:0 }}
                    </div>
                </div>
                {% empty %}
                <p class="empty-state">Sin movimientos.</p>
                {% endfor %}
            </div>
            <a href="{% url 'dentista:pagos' %}" class="card-footer-link">Ver historial completo</a>
        </div>

        <div class="cyber-card notif-card">
            <h4 class="card-title"><i class="ph-bold ph-bell"></i> Avisos</h4>
            <div class="notif-list">
                {% for aviso in notificaciones %}
                <div class="notif-item">
                    <p>{{ aviso.mensaje }}</p>
                    <small>{{ aviso.created_at|timesince }}</small>
                </div>
                {% empty %}
                <p class="empty-state">No hay avisos.</p>
                {% endfor %}
            </div>
        </div>

    </div>
</div>

{% endblock %}
