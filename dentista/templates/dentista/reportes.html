{% extends "dentista/base.html" %}
{% load static %}

{% block dtitle %}Reportes | RC Dental{% endblock %}

{% block dcontent %}

<div class="page-header compact" style="margin-bottom: 1rem;">
  <div>
    <h1 class="text-gradient">Reportes del Consultorio</h1>
    <p class="welcome-subtitle">Exporta tus movimientos entre fechas.</p>
  </div>
</div>

<div class="cyber-card" style="margin-bottom: 1rem; padding: 1.25rem;">
  <form method="get" class="filter-form" style="display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end;">
    <div>
      <label class="form-label">Desde</label>
      <input type="date" name="inicio" value="{{ fecha_inicio|date:'Y-m-d' }}" class="form-control">
    </div>
    <div>
      <label class="form-label">Hasta</label>
      <input type="date" name="fin" value="{{ fecha_fin|date:'Y-m-d' }}" class="form-control">
    </div>
    <button type="submit" class="cyber-btn">Filtrar</button>
    <a href="{% url 'dentista:reporte_csv' %}?inicio={{ fecha_inicio|date:'Y-m-d' }}&fin={{ fecha_fin|date:'Y-m-d' }}" class="cyber-btn cyber-btn-secondary">
      <i class="ph-bold ph-download-simple"></i> CSV
    </a>
    <a href="{% url 'dentista:reporte_pdf' %}?inicio={{ fecha_inicio|date:'Y-m-d' }}&fin={{ fecha_fin|date:'Y-m-d' }}" class="cyber-btn cyber-btn-glow">
      <i class="ph-bold ph-file-pdf"></i> PDF
    </a>
  </form>
</div>

<div class="cyber-card" style="padding: 1rem;">
  <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:10px;">
    <span><strong>Total citas:</strong> {{ total_citas }}</span>
    <span><strong>Pacientes:</strong> {{ total_pacientes }}</span>
    <span><strong>Ingresos cobrados:</strong> ${{ total_monto|floatformat:2 }}</span>
  </div>
  <h4 style="margin-top:0; margin-bottom:8px;">Citas</h4>
  <div class="table-responsive">
    <table class="finance-table">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Paciente</th>
          <th>Tratamiento</th>
          <th>Estado</th>
          <th style="text-align:right;">Monto</th>
        </tr>
      </thead>
      <tbody>
        {% for c in citas %}
        {% with pago=c.pago_relacionado %}
        <tr>
          <td>{{ c.fecha|date:"d/m/Y" }}<br><small style="color:#94a3b8;">{{ c.hora_inicio|time:"H:i" }}</small></td>
          <td>{{ c.paciente.nombre }}</td>
          <td>{{ c.servicio.nombre }}</td>
          <td>
            <span class="badge-pill {% if c.estado == 'COMPLETADA' %}green{% elif c.estado == 'PENDIENTE' %}yellow{% else %}blue{% endif %}">
              {{ c.estado }}
            </span>
          </td>
          <td style="text-align:right;">
            {% if pago %}
              <span style="display:block; font-weight:700;">${{ pago.monto|floatformat:2 }}</span>
              <small style="color:#94a3b8;">{{ pago.metodo }} | {{ pago.estado }}</small>
            {% else %}
              <small style="color:#94a3b8;">Sin pago</small>
            {% endif %}
          </td>
        </tr>
        {% endwith %}
        {% empty %}
        <tr><td colspan="5" style="text-align:center; padding:20px; color:#94a3b8;">No hay datos en el rango.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="cyber-card" style="padding: 1rem; margin-top: 1rem;">
  <h4 style="margin-top:0; margin-bottom:8px;">Pagos (incluye pendientes)</h4>
  <div class="table-responsive">
    <table class="finance-table">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Paciente</th>
          <th>Servicio</th>
          <th>MÃ©todo</th>
          <th>Estado</th>
          <th style="text-align:right;">Monto</th>
        </tr>
      </thead>
      <tbody>
        {% for p in pagos %}
        <tr>
          <td>{{ p.created_at|date:"d/m/Y" }}<br><small style="color:#94a3b8;">{{ p.created_at|time:"H:i" }}</small></td>
          <td>{{ p.cita.paciente.nombre }}</td>
          <td>{{ p.cita.servicio.nombre }}</td>
          <td>{{ p.metodo }}</td>
          <td>
            <span class="badge-pill {% if p.estado == 'COMPLETADO' %}green{% elif p.estado == 'PENDIENTE' %}yellow{% else %}blue{% endif %}">
              {{ p.estado }}
            </span>
          </td>
          <td style="text-align:right;">${{ p.monto|floatformat:2 }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="6" style="text-align:center; padding:20px; color:#94a3b8;">Sin pagos en el rango.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
