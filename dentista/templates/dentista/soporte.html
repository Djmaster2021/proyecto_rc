{% extends "dentista/base.html" %}
{% load static %}

{% block dtitle %}Centro de Ayuda | RC{% endblock %}

{% block extra_css %}
<style>
.support-page {
    font-size: 1.02rem;
    line-height: 1.7;
}
.support-page h1,
.support-page h3,
.support-page h4,
.support-page label,
.support-page summary {
    font-weight: 800;
    letter-spacing: -0.01em;
}
.support-page .page-header h1 {
    font-size: 2.1rem;
}
.support-page .welcome-subtitle {
    font-size: 1rem;
}
.support-page .search-hero-input {
    font-size: 1rem;
    padding: 12px 14px 12px 40px;
}
.support-page .cat-title {
    font-size: 1.1rem;
}
.support-page .cat-desc {
    font-size: 0.98rem;
}
.support-page .faq-item summary {
    font-size: 1rem;
    padding: 12px;
}
.support-page .faq-answer {
    font-size: 0.98rem;
    padding: 12px 14px 14px;
}
.support-page .cyber-input,
.support-page select,
.support-page textarea {
    font-size: 1rem;
    padding: 12px;
}
.support-page .cyber-btn {
    font-size: 1rem;
}
.support-page .method-item span {
    font-size: 0.95rem !important;
}
.support-page table.finance-table th,
.support-page table.finance-table td {
    font-size: 0.98rem;
}
.ticket-card {
    background: linear-gradient(135deg, rgba(15,23,42,0.85), rgba(30,41,59,0.95));
    border: 1px solid rgba(148,163,184,0.2);
    box-shadow: 0 20px 60px rgba(0,0,0,0.18);
    border-radius: 18px;
    padding: 1.5rem;
    position: relative;
    overflow: hidden;
}
.ticket-card::after {
    content: "";
    position: absolute;
    inset: 0;
    background: radial-gradient(120% 120% at 85% 10%, rgba(59,130,246,0.15), transparent 40%);
    pointer-events: none;
}
.ticket-meta {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    font-size: 0.9rem;
    color: var(--text-muted);
}
.pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border-radius: 999px;
    padding: 6px 10px;
    background: rgba(255,255,255,0.06);
    color: #e2e8f0;
    font-weight: 700;
    letter-spacing: -0.01em;
    font-size: 0.85rem;
}
.pill i { color: var(--brand); }
.quick-tags {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 1rem;
}
.quick-tags button {
    border: 1px solid rgba(148,163,184,0.4);
    background: rgba(255,255,255,0.05);
    color: #e2e8f0;
    border-radius: 10px;
    padding: 8px 12px;
    font-size: 0.88rem;
    cursor: pointer;
    transition: all .15s ease;
}
.quick-tags button:hover {
    border-color: var(--brand);
    color: #fff;
}
.steps {
    display: grid;
    gap: 10px;
    margin-top: 1rem;
}
.steps .step {
    display: grid;
    grid-template-columns: 40px 1fr;
    gap: 10px;
    align-items: center;
}
.steps .step .num {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    background: rgba(255,255,255,0.08);
    display: grid;
    place-items: center;
    color: #fff;
    font-weight: 800;
    border: 1px solid rgba(148,163,184,0.3);
}
.steps .step .copy {
    color: #cbd5e1;
    font-size: 0.92rem;
}
.history-card {
    border-radius: 14px;
    border: 1px solid rgba(148,163,184,0.25);
    background: rgba(255,255,255,0.6);
    backdrop-filter: blur(4px);
}
</style>
{% endblock %}

{% block dcontent %}

<div class="support-page">
<div class="page-header" style="margin-bottom: 1.5rem;">
    <div>
        <h1 class="text-gradient">Centro de Ayuda</h1>
        <p class="welcome-subtitle">Documentaci√≥n oficial y soporte t√©cnico.</p>
    </div>
    
    <div class="search-hero-box">
        <i class="ph-bold ph-magnifying-glass search-icon-overlay" style="position:absolute; left:15px; top:12px; color:var(--text-muted);"></i>
        <input type="text" id="faqSearch" class="search-hero-input" placeholder="Buscar en la documentaci√≥n...">
    </div>
</div>

<div class="system-status-bar">
    <div class="status-pulse-green"></div>
    <span>Todos los sistemas operativos &bull; v6.2.0 (Stable)</span>
    <span style="margin-left: auto; color: var(--text-muted); font-weight: 400;">Actualizado: {% now "H:i" %}</span>
</div>

<div class="support-grid">
    
    <div class="faq-container">
        
        <div class="support-category-card">
            <div class="cat-header">
                <div class="cat-icon cat-agenda"><i class="ph-fill ph-calendar-check"></i></div>
                <div>
                    <h3 class="cat-title">Agenda y Citas</h3>
                    <p class="cat-desc">Gesti√≥n de pacientes, horarios y reglas operativas.</p>
                </div>
            </div>
            
            <div class="faq-list">
                <details class="faq-item">
                    <summary>¬øC√≥mo funciona la regla de los 28 d√≠as? <i class="ph-bold ph-caret-down faq-icon"></i></summary>
                    <div class="faq-answer">El sistema bloquea citas consecutivas para evitar sobretratamiento si no han pasado 28 d√≠as. Contacta a administraci√≥n para excepciones.</div>
                </details>
                <details class="faq-item">
                    <summary>Gestionar cancelaciones y No-Shows <i class="ph-bold ph-caret-down faq-icon"></i></summary>
                    <div class="faq-answer">Usa el bot√≥n "Eliminar" en la cita. El sistema registra autom√°ticamente el incidente en el historial del paciente.</div>
                </details>
                <details class="faq-item">
                    <summary>Agendar fuera de horario laboral <i class="ph-bold ph-caret-down faq-icon"></i></summary>
                    <div class="faq-answer">Es posible, pero generar√° una alerta visual amarilla en la agenda indicando que es una excepci√≥n operativa.</div>
                </details>
            </div>
        </div>

        <div class="support-category-card">
            <div class="cat-header">
                <div class="cat-icon cat-money"><i class="ph-fill ph-coins"></i></div>
                <div>
                    <h3 class="cat-title">Pagos y Caja</h3>
                    <p class="cat-desc">Registro de ingresos, reportes y cortes.</p>
                </div>
            </div>
            
            <div class="faq-list">
                <details class="faq-item">
                    <summary>¬øC√≥mo registro un pago en efectivo? <i class="ph-bold ph-caret-down faq-icon"></i></summary>
                    <div class="faq-answer">Ve a la secci√≥n <strong>Finanzas > Nuevo Cobro</strong>. Selecciona la cita pendiente y confirma el monto recibido.</div>
                </details>
                <details class="faq-item">
                    <summary>Descargar reportes fiscales <i class="ph-bold ph-caret-down faq-icon"></i></summary>
                    <div class="faq-answer">En la secci√≥n <strong>Reportes</strong>, usa los botones de exportaci√≥n (PDF/CSV) situados en la esquina superior derecha.</div>
                </details>
            </div>
        </div>

        <div class="support-category-card">
            <div class="cat-header">
                <div class="cat-icon cat-user"><i class="ph-fill ph-user-gear"></i></div>
                <div>
                    <h3 class="cat-title">Mi Cuenta</h3>
                    <p class="cat-desc">Seguridad, perfil y horarios de atenci√≥n.</p>
                </div>
            </div>
            
            <div class="faq-list">
                <details class="faq-item">
                    <summary>Modificar mi disponibilidad <i class="ph-bold ph-caret-down faq-icon"></i></summary>
                    <div class="faq-answer">Ve a <strong>Configuraci√≥n</strong>. Puedes eliminar bloques de horario antiguos y crear nuevos turnos semanales.</div>
                </details>
            </div>
        </div>

    </div>

    <div>
        <div class="ticket-card">
            
            {% if messages %}
                {% for message in messages %}
                    <div class="alert-msg alert-{{ message.tags }}">
                        <i class="ph-bold {% if message.tags == 'success' %}ph-check-circle{% else %}ph-warning-circle{% endif %}"></i>
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            <div style="display:flex; align-items:flex-start; gap: 1rem; margin-bottom: 1.5rem;">
                <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.06); border:1px solid rgba(148,163,184,0.3); border-radius: 16px; display: flex; align-items: center; justify-content: center; color: var(--brand);">
                    <i class="ph-duotone ph-life-buoy" style="font-size: 2rem;"></i>
                </div>
                <div>
                    <h3 style="margin:0; color: #e2e8f0; font-size: 1.3rem; font-weight: 800;">Soporte T√©cnico</h3>
                    <div class="ticket-meta">
                        <span class="pill"><i class="ph-bold ph-bolt"></i> SLA &lt; 24h</span>
                        <span class="pill"><i class="ph-bold ph-headset"></i> Mesa N1</span>
                        <span class="pill"><i class="ph-bold ph-shield-check"></i> Prioridad m√©dica</span>
                    </div>
                </div>
            </div>
          
            <form method="post" action="{% url 'dentista:soporte' %}">
              {% csrf_token %}

              <div class="quick-tags">
                <button type="button" onclick="presetTicket('Error Cr√≠tico', 'Describe el mensaje de error en pantalla, antes y despu√©s. Incluye si estabas guardando una cita o pago.')">Error cr√≠tico</button>
                <button type="button" onclick="presetTicket('Agenda/Citas', 'Indica paciente, fecha/hora y qu√© intentabas hacer (crear, mover, cancelar).')">Agenda</button>
                <button type="button" onclick="presetTicket('Problema Pagos', 'Indica el paciente, monto y m√©todo. ¬øSe guard√≥ el pago o fall√≥?')">Pagos</button>
                <button type="button" onclick="presetTicket('Sugerencia', 'Cu√©ntanos la mejora que te gustar√≠a ver. Ej: reporte, alerta, integraci√≥n.')">Sugerencia</button>
              </div>
              
              <div class="form-group">
                <label style="font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase;">Categor√≠a</label>
                <div style="position: relative;">
                    <select name="asunto" id="asuntoInput" class="cyber-input" required style="appearance: none; background: rgba(255,255,255,0.05); color:#e2e8f0; border-color: rgba(148,163,184,0.3);">
                      <option value="" disabled selected>Selecciona el problema...</option>
                      <option value="Error Cr√≠tico">üî¥ Sistema Detenido</option>
                      <option value="Problema Pagos">üü° Finanzas / Caja</option>
                      <option value="Agenda/Citas">üîµ Agenda / Citas</option>
                      <option value="Sugerencia">‚ú® Sugerencia</option>
                    </select>
                    <i class="ph-bold ph-caret-down" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--text-muted);"></i>
                </div>
              </div>
          
              <div class="form-group">
                <label style="font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase;">Detalle</label>
                <textarea 
                  name="mensaje" 
                  id="mensajeInput"
                  rows="5" 
                  class="cyber-input" 
                  placeholder="Describe lo que sucedi√≥..." 
                  style="resize: none; background: rgba(255,255,255,0.05); color:#e2e8f0; border-color: rgba(148,163,184,0.3);"
                  required></textarea>
              </div>
          
              <button type="submit" class="cyber-btn cyber-btn-glow w-100" style="justify-content:center;">
                Enviar Ticket <i class="ph-bold ph-paper-plane-right"></i>
              </button>
            </form>

            <div style="margin-top: 1.5rem; padding: 1rem; border:1px dashed rgba(148,163,184,0.3); border-radius: 12px; background: rgba(255,255,255,0.03);">
                <div class="steps">
                    <div class="step">
                        <div class="num">1</div>
                        <div class="copy">Adjunta contexto: acci√≥n que realizabas y pantallazo si hay error.</div>
                    </div>
                    <div class="step">
                        <div class="num">2</div>
                        <div class="copy">Incluye paciente/servicio/monto si aplica (agenda o pagos).</div>
                    </div>
                    <div class="step">
                        <div class="num">3</div>
                        <div class="copy">Enviamos correo al soporte y respondemos en &lt;24h.</div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(148,163,184,0.2);">
                <p style="text-align: center; font-size: 0.8rem; color: #cbd5e1; margin-bottom: 1rem;">Contacto directo</p>
                <div class="contact-grid">
                    <a href="https://wa.me/523228892558?text=Hola%2C%20necesito%20soporte%20para%20el%20sistema%20RC%20Dental." target="_blank" class="method-item">
                        <i class="ph-fill ph-whatsapp-logo" style="font-size:1.5rem; color:#25D366;"></i>
                        <span style="font-weight: 700; font-size: 0.8rem; margin-top: 5px;">WhatsApp</span>
                    </a>
                    <a href="mailto:diegomag2996@gmail.com?subject=Soporte%20RC%20Dental&body=Describe%20tu%20problema..." class="method-item">
                        <i class="ph-fill ph-envelope-simple" style="font-size:1.5rem; color:var(--brand);"></i>
                        <span style="font-weight: 700; font-size: 0.8rem; margin-top: 5px;">Email</span>
                    </a>
                </div>
            </div>

        </div>

        <div class="cyber-card history-card" style="margin-top:1rem; padding:1rem;">
            <h3 style="margin:0 0 10px;">Historial de Tickets</h3>
            <div class="table-responsive">
                <table class="finance-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Asunto</th>
                            <th>Estado</th>
                            <th>Creado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for t in tickets %}
                        <tr>
                            <td>#{{ t.id }}</td>
                            <td>{{ t.asunto }}</td>
                            <td>
                                <span class="badge-pill {% if t.estado == 'ABIERTO' %}yellow{% elif t.estado == 'EN_PROCESO' %}blue{% else %}green{% endif %}">
                                    {{ t.estado }}
                                </span>
                            </td>
                            <td>{{ t.created_at|date:"d/m/Y H:i" }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" style="text-align:center; padding:12px; color:#94a3b8;">Sin tickets previos.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function presetTicket(asunto, detalle) {
    const asuntoInput = document.getElementById("asuntoInput");
    const mensajeInput = document.getElementById("mensajeInput");
    if (asuntoInput) {
        for (const opt of asuntoInput.options) {
            if (opt.value === asunto) { opt.selected = true; break; }
        }
    }
    if (mensajeInput && (!mensajeInput.value || mensajeInput.value.length < 10)) {
        mensajeInput.value = detalle;
    }
    if (mensajeInput) { mensajeInput.focus(); }
}
</script>
{% endblock %}
